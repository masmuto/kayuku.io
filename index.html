<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wood-IT | Sistem Pengelolaan Kayu Log Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Library untuk Ekspor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }

        #toast-container { position: fixed; top: 1rem; right: 1rem; left: 1rem; z-index: 9999; pointer-events: none; }
        @media (min-width: 768px) { #toast-container { left: auto; width: 320px; } }
        .toast { animation: slideIn 0.3s ease-out forwards; pointer-events: auto; }
        @keyframes slideIn { from { transform: translateY(-1rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 md:pb-0 flex flex-col md:flex-row">

    <div id="toast-container"></div>

    <!-- Sidebar (Desktop) -->
    <aside id="sidebar" class="hidden md:flex w-64 bg-slate-900 text-white p-6 flex-col space-y-8 no-print shrink-0 sticky top-0 h-screen">
        <div class="flex items-center space-x-3 px-2">
            <div class="bg-amber-600 p-2 rounded-lg shadow-lg shadow-amber-600/20"><i data-lucide="package" class="w-6 h-6"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight" id="sidebar-company-name">Wood-IT Log</h1>
                <p class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">Management System</p>
            </div>
        </div>

        <nav class="flex-1 space-y-1 overflow-y-auto" id="main-nav">
            <button onclick="switchView('dashboard')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="switchView('inventory')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-inventory">
                <i data-lucide="database" class="w-5 h-5"></i>
                <span>Stok Log</span>
            </button>
            <button onclick="switchView('sales')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-sales">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>Kayu Keluar</span>
            </button>
            <button onclick="switchView('expenses')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-expenses">
                <i data-lucide="receipt" class="w-5 h-5"></i>
                <span>Biaya & Beban</span>
            </button>
            
            <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Laporan</div>
            <button onclick="switchView('reports')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-reports">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                <span>Keuangan</span>
            </button>
            
            <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sistem</div>
            <button onclick="switchView('suppliers')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-suppliers">
                <i data-lucide="truck" class="w-5 h-5"></i>
                <span>Supplier</span>
            </button>
            <button onclick="switchView('customers')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-customers">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>Pelanggan</span>
            </button>
            
            <button onclick="switchView('settings')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>Pengaturan</span>
            </button>
        </nav>

        <div class="pt-6 border-t border-white/10">
            <button onclick="handleLogout()" class="w-full flex items-center justify-center space-x-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition">
                <i data-lucide="log-out" class="w-4 h-4"></i>
                <span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- Bottom Nav (Mobile) -->
    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 text-white flex justify-around items-center p-2 z-[60] no-print border-t border-white/5 pb-safe">
        <button onclick="switchView('dashboard')" class="flex flex-col items-center p-2 text-slate-400" id="mob-nav-dashboard">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span class="text-[9px] mt-1">Home</span>
        </button>
        <button onclick="switchView('inventory')" class="flex flex-col items-center p-2 text-slate-400" id="mob-nav-inventory">
            <i data-lucide="database" class="w-5 h-5"></i>
            <span class="text-[9px] mt-1">Stok</span>
        </button>
        <button onclick="switchView('sales')" class="flex flex-col items-center p-2 text-slate-400" id="mob-nav-sales">
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
            <span class="text-[9px] mt-1">Jual</span>
        </button>
        <button onclick="toggleMobileExtra()" class="flex flex-col items-center p-2 text-slate-400">
            <i data-lucide="menu" class="w-5 h-5"></i>
            <span class="text-[9px] mt-1">Menu</span>
        </button>
    </nav>

    <!-- Mobile Extra Menu Overlay -->
    <div id="mobile-extra-menu" class="fixed inset-0 bg-slate-900/95 z-[70] hidden flex flex-col p-8 no-print transition-all duration-300">
        <div class="flex justify-between items-center mb-10">
            <h3 class="text-amber-500 font-bold uppercase tracking-widest text-sm">Menu Tambahan</h3>
            <button onclick="toggleMobileExtra()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="space-y-6">
            <button onclick="switchView('expenses'); toggleMobileExtra()" class="w-full flex items-center space-x-4 text-white text-lg"><i data-lucide="receipt" class="w-6 h-6"></i> <span>Biaya & Beban</span></button>
            <button onclick="switchView('reports'); toggleMobileExtra()" class="w-full flex items-center space-x-4 text-white text-lg"><i data-lucide="pie-chart" class="w-6 h-6"></i> <span>Laporan Keuangan</span></button>
            <button onclick="switchView('suppliers'); toggleMobileExtra()" class="w-full flex items-center space-x-4 text-white text-lg"><i data-lucide="truck" class="w-6 h-6"></i> <span>Supplier</span></button>
            <button onclick="switchView('customers'); toggleMobileExtra()" class="w-full flex items-center space-x-4 text-white text-lg"><i data-lucide="users" class="w-6 h-6"></i> <span>Pelanggan</span></button>
            <button onclick="switchView('settings'); toggleMobileExtra()" class="w-full flex items-center space-x-4 text-white text-lg"><i data-lucide="settings" class="w-6 h-6"></i> <span>Pengaturan</span></button>
            <div class="pt-8 border-t border-white/10">
                <button onclick="handleLogout()" class="w-full flex items-center space-x-4 text-red-400 text-lg font-bold"><i data-lucide="log-out" class="w-6 h-6"></i> <span>Keluar Aplikasi</span></button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto w-full">
        <div id="loading" class="fixed inset-0 bg-white/80 z-[100] flex items-center justify-center no-print">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-600"></div>
        </div>

        <!-- Dashboard View -->
        <section id="view-dashboard" class="p-4 md:p-10 space-y-6 md:space-y-8 no-print">
            <header>
                <h2 class="text-xl md:text-2xl font-bold text-slate-800">Operasional Wood-IT</h2>
                <p class="text-xs text-slate-500">Monitoring real-time volume & keuangan.</p>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center md:block">
                    <div class="p-3 bg-amber-100 text-amber-600 rounded-xl md:mb-4 mr-4 md:mr-0"><i data-lucide="boxes" class="w-5 h-5"></i></div>
                    <div><h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Volume Stok</h3><p class="text-lg md:text-2xl font-black text-slate-900" id="stat-total-volume">0.00 m³</p></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center md:block">
                    <div class="p-3 bg-green-100 text-green-600 rounded-xl md:mb-4 mr-4 md:mr-0"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                    <div><h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Nilai Stok</h3><p class="text-lg md:text-2xl font-black text-slate-900" id="stat-total-price">Rp 0</p></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center md:block">
                    <div class="p-3 bg-red-100 text-red-600 rounded-xl md:mb-4 mr-4 md:mr-0"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                    <div><h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider text-red-500">Total Hutang</h3><p class="text-lg md:text-2xl font-black text-red-600" id="stat-total-debt">Rp 0</p></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center md:block">
                    <div class="p-3 bg-blue-100 text-blue-600 rounded-xl md:mb-4 mr-4 md:mr-0"><i data-lucide="arrow-down-left" class="w-5 h-5"></i></div>
                    <div><h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider text-blue-500">Total Piutang</h3><p class="text-lg md:text-2xl font-black text-blue-600" id="stat-total-receivable">Rp 0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 overflow-hidden">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center space-x-2"><i data-lucide="activity" class="w-4 h-4"></i> <span>Aktivitas Kas Terbaru</span></h3>
                <div id="recent-logs" class="space-y-3"></div>
            </div>
        </section>

        <!-- Stok Log Section -->
        <section id="view-inventory" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Stok Log (Pembelian)</h2></div>
                <button onclick="openModal('wood')" class="bg-amber-600 text-white px-5 py-3 rounded-xl text-sm font-bold shadow-lg shadow-amber-600/20">Input Nota Baru</button>
            </header>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold">
                            <tr><th class="px-5 py-4">No. Nota</th><th class="px-5 py-4">Supplier</th><th class="px-5 py-4 text-center">Status</th><th class="px-5 py-4 text-center">Volume (m³)</th><th class="px-5 py-4 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Kayu Keluar Section -->
        <section id="view-sales" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Kayu Keluar (Penjualan)</h2></div>
                <button onclick="openModal('sales')" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-600/20">Input Penjualan</button>
            </header>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold">
                            <tr><th class="px-5 py-4">SJ / Nota</th><th class="px-5 py-4">Pelanggan</th><th class="px-5 py-4 text-center font-bold">Volume (m³)</th><th class="px-5 py-4 text-right">Total</th><th class="px-5 py-4 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="sales-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Biaya Section -->
        <section id="view-expenses" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold">Biaya & Beban</h2><button onclick="openModal('expense')" class="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">Input Biaya</button></header>
            <div class="bg-white rounded-2xl border overflow-hidden"><table class="w-full text-left text-xs"><thead class="bg-slate-50 text-[9px] font-bold uppercase"><tr><th class="p-4">Tanggal</th><th class="p-4">Kategori</th><th class="p-4 text-right">Nominal</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="expenses-table-body" class="divide-y divide-slate-100"></tbody></table></div>
        </section>

        <!-- Laporan Section -->
        <section id="view-reports" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div><h2 class="text-xl font-bold">Laporan Keuangan</h2></div>
                <div class="flex gap-2">
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel</button>
                    <button onclick="exportToPDF()" class="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                </div>
            </header>
            <div id="report-content-to-export" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-2xl border shadow-sm">
                        <h3 class="font-bold text-sm mb-4 uppercase tracking-tighter">Laba Rugi (Accrual Basis)</h3>
                        <div class="space-y-2 text-sm divide-y">
                            <div class="flex justify-between py-2"><span>Penjualan</span><span class="font-bold text-green-600" id="report-total-revenue">Rp 0</span></div>
                            <div class="flex justify-between py-2"><span>Pembelian</span><span class="font-bold text-red-500" id="report-total-cogs">Rp 0</span></div>
                            <div class="flex justify-between py-2"><span>Biaya Ops</span><span class="font-bold text-red-400" id="report-total-expenses">Rp 0</span></div>
                            <div class="flex justify-between py-2 font-black border-t-2 text-base"><span>Net Profit</span><span id="report-gross-profit-accrual">Rp 0</span></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border shadow-sm">
                        <h3 class="font-bold text-sm mb-4 uppercase tracking-tighter text-blue-600">Arus Kas (Cash Flow)</h3>
                        <div class="space-y-2 text-sm divide-y">
                            <div class="flex justify-between py-2"><span>Uang Masuk</span><span class="font-bold text-emerald-600" id="report-cash-in">Rp 0</span></div>
                            <div class="flex justify-between py-2"><span>Uang Keluar</span><span class="font-bold text-rose-500" id="report-cash-out">Rp 0</span></div>
                            <div class="flex justify-between py-2 font-black border-t-2 text-base"><span>Saldo Kas</span><span id="report-net-cash" class="text-blue-700">Rp 0</span></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border overflow-hidden">
                    <table class="w-full text-xs text-left" id="table-cashflow">
                        <thead class="bg-slate-50 uppercase text-[9px] font-bold">
                            <tr><th class="p-4">Waktu</th><th class="p-4">Ket</th><th class="p-4 text-center">Tipe</th><th class="p-4 text-right">Nominal</th></tr>
                        </thead>
                        <tbody id="cashflow-table-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Kontak Sections -->
        <section id="view-suppliers" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold">Supplier</h2><button onclick="openModal('contact', 'supplier')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold">Tambah</button></header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="suppliers-list"></div>
        </section>
        <section id="view-customers" class="hidden p-4 md:p-10 space-y-6 no-print">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold">Pelanggan</h2><button onclick="openModal('contact', 'customer')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold">Tambah</button></header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="customers-list"></div>
        </section>

        <!-- Pengaturan Section -->
        <section id="view-settings" class="hidden p-4 md:p-10 space-y-6 no-print">
            <h2 class="text-xl font-bold">Pengaturan</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                    <h3 class="font-bold text-sm">Profil Bisnis (Header Cetak)</h3>
                    <div class="space-y-4">
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Nama Bisnis</label><input type="text" id="setting-company-name" placeholder="Nama Bisnis" class="w-full p-3 rounded-xl border outline-none"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Alamat</label><textarea id="setting-company-address" rows="2" placeholder="Alamat Lengkap" class="w-full p-3 rounded-xl border outline-none"></textarea></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Telepon</label><input type="text" id="setting-company-phone" placeholder="Nomor Telepon" class="w-full p-3 rounded-xl border outline-none"></div>
                        <button onclick="saveCompanyProfile()" class="w-full py-3 bg-amber-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition">Simpan Profil</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                    <h3 class="font-bold text-sm text-red-600 uppercase tracking-tighter">Database & Backup</h3>
                    <div class="space-y-3">
                        <button onclick="handleBackupDatabase()" class="w-full py-3 bg-slate-900 text-white rounded-xl text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Cadangkan JSON</button>
                        <input type="file" id="restore-db-input" class="hidden" accept=".json" onchange="handleRestoreDatabase(event)">
                        <button onclick="document.getElementById('restore-db-input').click()" class="w-full py-3 bg-emerald-600 text-white rounded-xl text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> Pulihkan JSON</button>
                        <button onclick="handleResetDatabase()" class="w-full py-2 text-red-600 text-[10px] font-bold uppercase border-t border-slate-100 mt-4">Hapus Seluruh Data</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Kayu Masuk -->
    <div id="wood-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-2 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl flex flex-col max-h-[95vh] my-auto">
            <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 id="wood-modal-title" class="font-bold text-sm uppercase">Input Nota Log Baru</h3>
                <button onclick="closeModal('wood')" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-5 overflow-y-auto space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-2xl">
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400">No. Nota</label><input type="text" id="wood-nota" placeholder="INV-001" class="w-full p-3 border rounded-xl text-sm outline-none"></div>
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400">Supplier</label><select id="wood-supplier-select" class="w-full p-3 border rounded-xl text-sm outline-none"></select></div>
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400">Total Harga Batch</label><input type="number" id="wood-total-nota-price" class="w-full p-3 border rounded-xl text-sm font-bold text-amber-700 outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-amber-50 p-4 rounded-2xl border border-amber-100">
                    <select id="wood-payment-status" onchange="toggleDPInput('wood')" class="p-3 rounded-xl border text-sm outline-none"><option value="Hutang">Hutang</option><option value="Lunas">Lunas</option><option value="DP">DP</option></select>
                    <input type="number" id="wood-dp-amount" placeholder="Nominal DP" class="hidden p-3 rounded-xl border text-sm outline-none bg-white">
                </div>
                <!-- Pengukuran Kayu -->
                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-4 space-y-4">
                    <div class="grid grid-cols-2 gap-2"><input type="text" id="wood-type" class="p-3 border rounded-xl text-sm" placeholder="Jenis (Jati/Sengon)"><input type="number" id="log-p" oninput="liveUpdateCalc()" class="p-3 border rounded-xl text-sm" placeholder="Panjang (cm)"></div>
                    <div class="grid grid-cols-2 gap-2"><input type="text" id="log-no" class="p-3 border rounded-xl text-sm" placeholder="Tag / No LOG"><input type="text" id="log-grade" class="p-3 border rounded-xl text-sm" placeholder="Grade (A1/A2/..)"></div>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.1" id="log-d1" oninput="liveUpdateCalc()" class="p-2 border rounded-lg text-center text-xs" placeholder="d1">
                        <input type="number" step="0.1" id="log-d2" oninput="liveUpdateCalc()" class="p-2 border rounded-lg text-center text-xs" placeholder="d2">
                        <input type="number" step="0.1" id="log-d3" oninput="liveUpdateCalc()" class="p-2 border rounded-lg text-center text-xs" placeholder="d3">
                        <input type="number" step="0.1" id="log-d4" oninput="liveUpdateCalc()" class="p-2 border rounded-lg text-center text-xs" placeholder="d4">
                    </div>
                    <div class="grid grid-cols-2 gap-2"><input type="number" id="log-trim" oninput="liveUpdateCalc()" class="p-3 border rounded-xl text-sm" placeholder="Trim (cm)"><input type="number" id="log-gr" oninput="liveUpdateCalc()" class="p-3 border rounded-xl text-sm" placeholder="GR (cm)"></div>
                    <div class="bg-slate-900 text-white p-3 rounded-xl flex justify-around text-center">
                        <div><p class="text-[9px] text-slate-500 uppercase">Rata D</p><p id="res-live-avg-d" class="font-bold">0 cm</p></div>
                        <div><p class="text-[9px] text-slate-500 uppercase">Vol GR</p><p id="res-live-vol-gr" class="font-bold">0.00</p></div>
                        <div><p class="text-[9px] text-slate-500 uppercase">Neto</p><p id="res-live-vol-wood" class="font-bold text-amber-500">0.00</p></div>
                    </div>
                    <button onclick="addItemToBatch('wood')" class="w-full bg-amber-600 text-white py-4 rounded-xl font-bold shadow-lg transition active:scale-95 uppercase tracking-widest text-xs">TAMBAH KE DAFTAR NOTA</button>
                </div>
                <div class="border rounded-2xl overflow-hidden"><table class="w-full text-xs text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3">No LOG</th><th class="p-3">Jenis</th><th class="p-3 text-center">Neto (m³)</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="wood-batch-table"></tbody></table></div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex space-x-2"><button onclick="closeModal('wood')" class="flex-1 py-4 border rounded-xl">Batal</button><button onclick="submitBatchToFirebase()" id="btn-save-batch-wood" disabled class="flex-1 py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg">SIMPAN NOTA MASUK</button></div>
        </div>
    </div>

    <!-- Modal Detail & Cetak -->
    <div id="detail-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center p-2 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-5xl rounded-3xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b flex justify-between items-center bg-white rounded-t-3xl"><h3 id="detail-title" class="font-bold text-slate-800 text-xs uppercase">Detail Transaksi</h3><button onclick="closeModal('detail')" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="p-5 overflow-y-auto space-y-6">
                <div id="detail-metadata" class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-xl text-xs">
                    <div><p class="font-bold text-slate-400 uppercase">Nota</p><p id="detail-meta-invoice" class="font-bold text-slate-800">-</p></div>
                    <div><p id="detail-meta-contact-label" class="font-bold text-slate-400 uppercase">Pihak</p><p id="detail-meta-contact-name" class="font-bold text-slate-800">-</p></div>
                    <div><p class="font-bold text-slate-400 uppercase">Status</p><p id="detail-meta-status" class="font-bold">-</p></div>
                    <div><p class="font-bold text-slate-400 uppercase">Total Nilai</p><p id="detail-meta-total" class="font-black text-blue-600">-</p></div>
                </div>
                <div class="overflow-x-auto border rounded-xl">
                    <table class="w-full text-[10px] text-left min-w-[700px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3">No LOG</th><th class="p-3">Jenis/Grade</th><th class="p-3 text-center">P (cm)</th><th class="p-3 text-center">D (cm)</th><th class="p-3 text-center">Vol (m³)</th><th class="p-3 text-right">Harga</th></tr></thead><tbody id="detail-table-body" class="divide-y"></tbody></table>
                </div>
                <button onclick="printNotaDetail()" class="w-full py-4 bg-amber-600 text-white rounded-2xl font-bold shadow-lg flex items-center justify-center space-x-2 transition active:scale-95"><i data-lucide="printer" class="w-5 h-5"></i> <span>CETAK DOKUMEN PROFESIONAL</span></button>
            </div>
        </div>
    </div>

    <!-- Modal Kayu Keluar -->
    <div id="sales-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-2 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 space-y-4 shadow-2xl flex flex-col my-auto">
            <h3 class="font-bold text-sm uppercase">Input Penjualan (Surat Jalan)</h3>
            <div class="space-y-4">
                <input type="text" id="sales-nota" placeholder="SJ/2026/001" class="w-full p-3 rounded-xl border text-sm outline-none">
                <select id="sales-customer-select" class="w-full p-3 rounded-xl border text-sm outline-none"></select>
                <div class="border-2 border-dashed border-slate-200 p-4 rounded-xl space-y-4">
                    <select id="sales-stock-item-select" onchange="autoFillSalesFromStock()" class="w-full p-3 rounded-xl border text-sm outline-none"></select>
                    <div class="grid grid-cols-2 gap-2"><input type="text" id="sales-wood-type" placeholder="Jenis" class="p-3 rounded-xl border text-sm outline-none"><input type="number" id="sales-wood-vol" placeholder="Vol" class="p-3 rounded-xl border text-sm outline-none"></div>
                    <input type="number" id="sales-wood-price" placeholder="Harga Jual" class="w-full p-3 rounded-xl border text-sm outline-none font-bold">
                    <button onclick="addItemToBatch('sales')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-xs">+ Tambah Ke SJ</button>
                </div>
                <div class="border rounded-xl max-h-40 overflow-y-auto"><table class="w-full text-[10px]"><tbody id="sales-batch-table"></tbody></table></div>
            </div>
            <div class="flex space-x-2 pt-2"><button onclick="closeModal('sales')" class="flex-1 py-3.5 border rounded-xl text-sm font-medium">Batal</button><button onclick="submitBatchSalesToFirebase()" id="btn-save-batch-sales" disabled class="flex-1 py-3.5 bg-slate-900 text-white font-bold rounded-xl text-sm">Simpan SJ</button></div>
        </div>
    </div>

    <!-- Modals Utility (Expense, Contact, Payment) -->
    <div id="expense-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl"><h3 class="font-bold text-sm uppercase">Input Biaya Ops</h3><form onsubmit="handleExpenseSubmit(event)" class="space-y-4"><select id="expense-category" class="w-full p-3 rounded-xl border text-sm outline-none" required><option value="Gaji">Gaji</option><option value="Operasional">Operasional</option><option value="BBM">BBM/Solar</option><option value="Lain-lain">Lain-lain</option></select><input type="number" id="expense-amount" placeholder="Nominal" class="w-full p-3 rounded-xl border text-sm outline-none font-bold" required><textarea id="expense-note" placeholder="Ket" class="w-full p-3 rounded-xl border text-sm outline-none"></textarea><button type="submit" class="w-full py-3.5 bg-rose-500 text-white rounded-xl font-bold text-sm">Simpan</button><button type="button" onclick="closeModal('expense')" class="w-full py-2 text-slate-400 text-xs text-center block">Batal</button></form></div></div>
    <div id="contact-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl"><h3 id="contact-modal-title" class="font-bold text-sm uppercase">Tambah Pihak</h3><form onsubmit="handleContactSubmit(event)" class="space-y-4"><input type="hidden" id="contact-type"><input type="text" id="contact-name" placeholder="Nama" class="w-full p-3 rounded-xl border text-sm outline-none font-bold" required><input type="text" id="contact-phone" placeholder="No Telp" class="w-full p-3 rounded-xl border text-sm outline-none"><button type="submit" class="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold text-sm">Simpan</button><button type="button" onclick="closeModal('contact')" class="w-full py-2 text-slate-400 text-xs text-center block">Batal</button></form></div></div>
    <div id="payment-modal" class="fixed inset-0 z-[130] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-6 shadow-2xl"><h3 id="payment-title" class="font-black text-slate-800 uppercase text-sm">Pembayaran</h3><div class="bg-slate-50 p-4 rounded-2xl"><p class="text-[9px] font-bold text-slate-400 uppercase">Sisa Saldo</p><p id="payment-current-balance" class="text-lg font-black text-slate-900">Rp 0</p></div><form onsubmit="handlePaymentSubmit(event)" class="space-y-4"><input type="hidden" id="payment-contact-id"><input type="number" id="payment-amount" placeholder="Nominal" class="w-full p-4 rounded-2xl border text-sm font-bold outline-none" required><textarea id="payment-note" placeholder="Catatan" class="w-full p-4 rounded-2xl border text-sm outline-none"></textarea><button type="submit" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition">Konfirmasi Pembayaran</button><button type="button" onclick="closeModal('payment')" class="w-full py-2 text-slate-400 text-xs font-bold uppercase text-center block">Batal</button></form></div></div>

    <iframe id="print-frame" style="display:none; visibility:hidden; position:absolute;"></iframe>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, serverTimestamp, writeBatch, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
          apiKey: "AIzaSyAxBA0yDhQHyMBE_vV5_zBlME_rJE9FZB0",
          authDomain: "adamlog-bd115.firebaseapp.com",
          projectId: "adamlog-bd115",
          storageBucket: "adamlog-bd115.firebasestorage.app",
          messagingSenderId: "135481704129",
          appId: "1:135481704129:web:06a890feed36d933955e40"
        };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        let inventoryData = [], contactsData = [], salesData = [], transactionsData = [], expensesData = [];
        let temporaryBatchWood = [], temporaryBatchSales = [], currentLiveVolWood = 0, currentLiveAvgD = 0, currentLiveVolGR = 0, companyProfile = { name: "Wood-IT Log", address: "Jl. Utama", phone: "0812" };
        let currentDetailItems = [], currentDetailNota = '', currentDetailType = '';

        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        
        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type==='success'?'bg-emerald-600':'bg-rose-600'} text-white px-5 py-3 rounded-2xl shadow-xl mb-3 flex items-center space-x-3`;
            toast.innerHTML = `<span class="text-xs font-bold">${msg}</span>`;
            container.appendChild(toast); refreshIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        // --- UI Navigation ---
        window.switchView = (view) => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`view-${view}`);
            if (target) target.classList.remove('hidden');
            refreshIcons(); window.scrollTo(0,0);
        };

        window.openModal = (type, sub = '') => {
            const m = document.getElementById(`${type}-modal`);
            if (m) {
                if (type === 'contact') document.getElementById('contact-type').value = sub;
                m.classList.remove('hidden');
            }
            refreshIcons();
        };

        window.closeModal = (id) => {
            const m = document.getElementById(`${id}-modal`);
            if (m) m.classList.add('hidden');
            if(id === 'wood') { temporaryBatchWood = []; renderBatch('wood'); }
            if(id === 'sales') { temporaryBatchSales = []; renderBatch('sales'); }
        };

        window.toggleMobileExtra = () => {
            const menu = document.getElementById('mobile-extra-menu');
            if (menu) menu.classList.toggle('hidden');
        };

        // --- Technical Wood Calculations ---
        window.liveUpdateCalc = () => {
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const d1=getVal('log-d1'), d2=getVal('log-d2'), d3=getVal('log-d3'), d4=getVal('log-d4'), p=getVal('log-p'), trim=getVal('log-trim'), gr=getVal('log-gr');
            currentLiveAvgD = Math.round((d1+d2+d3+d4)/4);
            
            // Logic based on standard: Vol Neto = Vol Bruto - Vol GR
            // Vol Bruto uses Effective Length (P - Trim)
            // Vol GR uses Actual Length (P)
            const pEffMeter = (p - trim) / 100, pAsliMeter = p / 100;
            const volBruto = (0.7854 * Math.pow(currentLiveAvgD, 2) * pEffMeter) / 10000;
            currentLiveVolGR = (0.7854 * Math.pow(gr, 2) * pAsliMeter) / 10000;
            currentLiveVolWood = Math.max(0, volBruto - currentLiveVolGR);
            
            document.getElementById('res-live-avg-d').innerText = `${currentLiveAvgD} cm`;
            document.getElementById('res-live-vol-gr').innerText = currentLiveVolGR.toFixed(2);
            document.getElementById('res-live-vol-wood').innerText = currentLiveVolWood.toFixed(2);
        };

        // --- Batch Items ---
        window.addItemToBatch = (type) => {
            if (type === 'wood') {
                const woodType = document.getElementById('wood-type').value;
                if(!woodType || currentLiveVolWood <= 0) return showToast("Lengkapi data pengukuran!", "error");
                temporaryBatchWood.push({ 
                    type: woodType, 
                    unitVolume: parseFloat(currentLiveVolWood.toFixed(2)), 
                    volGR: parseFloat(currentLiveVolGR.toFixed(2)),
                    noLog: document.getElementById('log-no').value, 
                    grade: document.getElementById('log-grade').value,
                    d1: parseFloat(document.getElementById('log-d1').value)||0, d2: parseFloat(document.getElementById('log-d2').value)||0,
                    d3: parseFloat(document.getElementById('log-d3').value)||0, d4: parseFloat(document.getElementById('log-d4').value)||0,
                    avgD: currentLiveAvgD, 
                    p: parseFloat(document.getElementById('log-p').value), 
                    trim: parseFloat(document.getElementById('log-trim').value)||0
                });
            } else {
                const vol = parseFloat(document.getElementById('sales-wood-vol').value)||0, prc = parseFloat(document.getElementById('sales-wood-price').value)||0;
                if (!vol || !prc) return showToast("Lengkapi data penjualan!", "error");
                const stockId = document.getElementById('sales-stock-item-select').value;
                temporaryBatchSales.push({ 
                    woodType: document.getElementById('sales-wood-type').value, 
                    volume: vol, 
                    price: prc, 
                    stockId 
                });
            }
            renderBatch(type);
        };

        const renderBatch = (type) => {
            const list = type === 'wood' ? temporaryBatchWood : temporaryBatchSales;
            const table = document.getElementById(`${type}-batch-table`);
            if (table) {
                table.innerHTML = list.map((i, idx) => `
                    <tr class="border-b">
                        <td class="p-3">${i.noLog||'-'}</td>
                        <td class="p-3 font-bold">${i.type||i.woodType}</td>
                        <td class="p-3 text-center">${(i.unitVolume||i.volume).toFixed(2)}</td>
                        <td class="p-3 text-right"><button onclick="removeFromBatch('${type}', ${idx})" class="text-rose-500 font-bold">X</button></td>
                    </tr>`).join('');
            }
            const btn = document.getElementById(`btn-save-batch-${type}`);
            if(btn) btn.disabled = list.length === 0;
        };
        window.renderBatch = renderBatch;
        window.removeFromBatch = (type, idx) => { if(type==='wood') temporaryBatchWood.splice(idx,1); else temporaryBatchSales.splice(idx,1); renderBatch(type); };

        // --- Database Logic ---
        window.submitBatchToFirebase = async () => {
            if(!auth.currentUser) return;
            const nota = document.getElementById('wood-nota').value, sid = document.getElementById('wood-supplier-select').value, total = parseFloat(document.getElementById('wood-total-nota-price').value)||0, st = document.getElementById('wood-payment-status').value, dp = parseFloat(document.getElementById('wood-dp-amount').value)||0;
            if(!nota || !sid) return showToast("Data nota/supplier wajib diisi!", "error");
            
            const batch = writeBatch(db); 
            const prcPerItem = total / temporaryBatchWood.length;
            
            temporaryBatchWood.forEach(i => {
                batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory')), { ...i, nota, supplierId: sid, paymentStatus: st, totalPrice: prcPerItem, createdAt: serverTimestamp() });
            });
            
            let newDebt = st === 'Hutang' ? total : (st === 'DP' ? total - dp : 0);
            if(newDebt > 0) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'contacts', sid), { balance: increment(newDebt) });
            
            let cashOut = st === 'Lunas' ? total : (st === 'DP' ? dp : 0);
            if(cashOut > 0) batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'out', amount: cashOut, note: `Beli Log: ${nota}`, time: serverTimestamp() });
            
            await batch.commit(); closeModal('wood'); showToast("Nota pembelian berhasil disimpan.");
        };

        window.submitBatchSalesToFirebase = async () => {
            if(!auth.currentUser) return;
            const nota = document.getElementById('sales-nota').value, cid = document.getElementById('sales-customer-select').value;
            if(!nota || !cid) return showToast("Data nota/pelanggan wajib diisi!", "error");
            
            const batch = writeBatch(db); 
            let totalSales = 0;
            temporaryBatchSales.forEach(i => { 
                totalSales += i.price; 
                batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'sales')), { ...i, nota, customerId: cid, createdAt: serverTimestamp() }); 
                if(i.stockId) batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', i.stockId)); 
            });
            
            batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'in', amount: totalSales, note: `Jual Log: ${nota}`, time: serverTimestamp() });
            await batch.commit(); closeModal('sales'); showToast("Surat jalan penjualan disimpan.");
        };

        window.handlePaymentSubmit = async (e) => {
            e.preventDefault();
            if(!auth.currentUser) return;
            const cid = document.getElementById('payment-contact-id').value, amt = parseFloat(document.getElementById('payment-amount').value), note = document.getElementById('payment-note').value;
            const contact = contactsData.find(c => c.id === cid);
            if (!contact || amt <= 0) return;
            const batch = writeBatch(db);
            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'contacts', cid), { balance: increment(-amt) });
            batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: contact.type==='supplier'?'out':'in', amount: amt, note: `Bayar/Pelunasan: ${contact.name} - ${note}`, time: serverTimestamp() });
            await batch.commit(); closeModal('payment'); showToast("Pembayaran diproses dan saldo diperbarui.");
        };

        window.handleExpenseSubmit = async (e) => {
            e.preventDefault();
            if(!auth.currentUser) return;
            const amt = parseFloat(document.getElementById('expense-amount').value);
            const batch = writeBatch(db);
            batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses')), { category: document.getElementById('expense-category').value, amount: amt, note: document.getElementById('expense-note').value, createdAt: serverTimestamp() });
            batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'out', amount: amt, note: `Biaya: ${document.getElementById('expense-category').value}`, time: serverTimestamp() });
            await batch.commit(); closeModal('expense'); showToast("Biaya pengeluaran dicatat.");
        };

        window.handleContactSubmit = async (e) => {
            e.preventDefault();
            if(!auth.currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), { type: document.getElementById('contact-type').value, name: document.getElementById('contact-name').value, phone: document.getElementById('contact-phone').value, balance: 0 });
            closeModal('contact'); showToast("Pihak baru berhasil didaftarkan.");
        };

        window.saveCompanyProfile = async () => {
            if(!auth.currentUser) return;
            const name = document.getElementById('setting-company-name').value;
            const address = document.getElementById('setting-company-address').value;
            const phone = document.getElementById('setting-company-phone').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'company'), { name, address, phone });
            showToast("Profil bisnis berhasil diperbarui.");
        };

        // --- Render & Exports ---
        window.showDetail = (type, nota) => {
            let itms = [], contact = null, total = 0;
            if (type === 'inventory') {
                itms = inventoryData.filter(i => i.nota === nota);
                contact = contactsData.find(c => c.id === itms[0]?.supplierId);
                total = itms.reduce((a, b) => a + (b.totalPrice || 0), 0);
                document.getElementById('detail-meta-contact-label').innerText = "Supplier";
            } else {
                itms = salesData.filter(i => i.nota === nota);
                contact = contactsData.find(c => c.id === itms[0]?.customerId);
                total = itms.reduce((a, b) => a + (b.price || 0), 0);
                document.getElementById('detail-meta-contact-label').innerText = "Pelanggan";
            }
            currentDetailItems = itms; currentDetailNota = nota; currentDetailType = type;
            document.getElementById('detail-meta-invoice').innerText = nota;
            document.getElementById('detail-meta-contact-name').innerText = contact?.name || '-';
            document.getElementById('detail-meta-status').innerText = itms[0]?.paymentStatus || 'Lunas';
            document.getElementById('detail-meta-total').innerText = formatCurrency(total);
            document.getElementById('detail-table-body').innerHTML = itms.map(i => `
                <tr>
                    <td class="p-3">${i.noLog||'-'}</td>
                    <td class="p-3 font-bold">${i.type||i.woodType} / ${i.grade||'-'}</td>
                    <td class="p-3 text-center">${i.p || '-'}</td>
                    <td class="p-3 text-center">${i.avgD || '-'}</td>
                    <td class="p-3 text-center font-bold text-amber-700">${(i.unitVolume||i.volume).toFixed(2)}</td>
                    <td class="p-3 text-right">${formatCurrency(i.totalPrice||i.price)}</td>
                </tr>`).join('');
            openModal('detail');
        };

        window.printNotaDetail = () => {
            const frame = document.getElementById('print-frame');
            const totalVol = currentDetailItems.reduce((a, b) => a + (b.unitVolume || b.volume || 0), 0);
            const totalPrice = currentDetailItems.reduce((a, b) => a + (b.totalPrice || b.price || 0), 0);
            const contactName = document.getElementById('detail-meta-contact-name').innerText;
            const docTitle = currentDetailType === 'inventory' ? 'NOTA PEMBELIAN KAYU LOG' : 'SURAT JALAN / PENJUALAN';
            const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            const content = `<html><head><style>body { font-family: sans-serif; padding: 40px; color: #1e293b; } .header { border-bottom: 3px solid #334155; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; } .biz-info h1 { margin: 0; font-size: 26px; color: #b45309; text-transform: uppercase; } table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 11px; } th, td { border: 1px solid #e2e8f0; padding: 10px; } .text-right { text-align: right; } .total-row { background: #f1f5f9; font-weight: 800; }</style></head><body><div class="header"><div class="biz-info"><h1>${companyProfile.name}</h1><p>${companyProfile.address}</p><p>Telp: ${companyProfile.phone}</p></div><div style="text-align: right"><p>Tanggal: ${dateStr}</p></div></div><h2 style="text-align:center">${docTitle}</h2><div style="display:grid; grid-template-cols:1fr 1fr; margin-bottom:20px; font-size:12px"><div><p><b>Nota</b>: ${currentDetailNota}</p><p><b>Partner</b>: ${contactName}</p></div><div style="text-align:right"><p><b>Status</b>: ${document.getElementById('detail-meta-status').innerText}</p></div></div><table><thead><tr><th>No</th><th>No LOG</th><th>Jenis</th><th>P (cm)</th><th>Avg D (cm)</th><th>Vol (m³)</th><th class="text-right">Total</th></tr></thead><tbody>${currentDetailItems.map((i, index) => `<tr><td>${index+1}</td><td>${i.noLog||'-'}</td><td>${i.type||i.woodType}</td><td>${i.p||'-'}</td><td>${i.avgD||'-'}</td><td>${(i.unitVolume||i.volume).toFixed(2)}</td><td class="text-right">${formatCurrency(i.totalPrice||i.price)}</td></tr>`).join('')}<tr class="total-row"><td colspan="5" class="text-right">TOTAL VOLUME</td><td>${totalVol.toFixed(2)} m³</td><td></td></tr><tr class="total-row"><td colspan="6" class="text-right">GRAND TOTAL</td><td class="text-right">${formatCurrency(totalPrice)}</td></tr></tbody></table></body></html>`;
            const doc_p = frame.contentWindow.document; doc_p.open(); doc_p.write(content); doc_p.close();
            setTimeout(() => { frame.contentWindow.focus(); frame.contentWindow.print(); }, 500);
        };

        window.exportToExcel = () => { const ws = XLSX.utils.json_to_sheet(inventoryData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Stok Inventaris"); XLSX.writeFile(wb, "WoodIT_Stok_Log.xlsx"); };
        window.exportToPDF = () => { const element = document.getElementById('report-content-to-export'); html2pdf().from(element).save("Laporan_Keuangan_WoodIT.pdf"); };

        // --- Data Sync ---
        const startSync = (user) => {
            if(!user) return;
            const errorHandler = (err) => console.warn("Firestore Listener Error:", err.code);

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), s => { inventoryData = s.docs.map(d=>({id:d.id, ...d.data()})); renderInventory(); updateStats(); }, errorHandler);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), s => { contactsData = s.docs.map(d=>({id:d.id, ...d.data()})); renderContacts(); updateSelects(); updateStats(); }, errorHandler);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), s => { salesData = s.docs.map(d=>({id:d.id, ...d.data()})); renderSales(); updateStats(); }, errorHandler);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => { transactionsData = s.docs.map(d=>({id:d.id, ...d.data()})); renderTransactions(); updateStats(); }, errorHandler);
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), s => { expensesData = s.docs.map(d=>({id:d.id, ...d.data()})); renderExpenses(); updateStats(); }, errorHandler);
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'company'), s => { if(s.exists()){ companyProfile = s.data(); document.getElementById('sidebar-company-name').innerText = companyProfile.name; document.getElementById('setting-company-name').value = companyProfile.name; document.getElementById('setting-company-address').value = companyProfile.address; document.getElementById('setting-company-phone').value = companyProfile.phone; } }, errorHandler);
        };

        window.renderInventory = () => {
            const g = inventoryData.reduce((acc, i) => { if(!acc[i.nota]) acc[i.nota] = {...i, vol:0}; acc[i.nota].vol += (i.unitVolume||0); return acc; }, {});
            const body = document.getElementById('inventory-table-body');
            if(body) body.innerHTML = Object.values(g).map(n => `<tr class="hover:bg-slate-50 transition"><td class="px-5 py-4 font-bold text-blue-600">${n.nota}</td><td class="px-5 py-4">${contactsData.find(c=>c.id===n.supplierId)?.name || '-'}</td><td class="px-5 py-4 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${n.paymentStatus==='Lunas'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${n.paymentStatus}</span></td><td class="px-5 py-4 text-center font-bold">${n.vol.toFixed(2)}</td><td class="px-5 py-4 text-right flex justify-end space-x-2"><button onclick="showDetail('inventory','${n.nota}')" class="p-1.5 bg-slate-100 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button><button onclick="deleteInventory('${n.nota}')" class="p-1.5 bg-red-50 text-red-500 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
            refreshIcons();
        };

        window.renderSales = () => {
            const g = salesData.reduce((acc, i) => { if(!acc[i.nota]) acc[i.nota] = {...i, vol:0, prc:0}; acc[i.nota].vol += (i.volume||0); acc[i.nota].prc += (i.price||0); return acc; }, {});
            const body = document.getElementById('sales-table-body');
            if(body) body.innerHTML = Object.values(g).map(n => `<tr class="hover:bg-slate-50 transition"><td class="px-5 py-4 font-bold text-blue-600">${n.nota}</td><td class="px-5 py-4">${contactsData.find(c=>c.id===n.customerId)?.name || '-'}</td><td class="px-5 py-4 text-center font-bold">${n.vol.toFixed(2)}</td><td class="px-5 py-4 text-right font-black">${formatCurrency(n.prc)}</td><td class="px-5 py-4 text-right flex justify-end space-x-2"><button onclick="showDetail('sales','${n.nota}')" class="p-1.5 bg-slate-100 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button><button onclick="deleteSales('${n.nota}')" class="p-1.5 bg-red-50 text-red-500 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
            refreshIcons();
        };

        window.renderContacts = () => {
            const card = (c) => `<div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm space-y-4 hover:shadow-lg transition"><h4 class="font-bold text-sm text-slate-900">${c.name}</h4><div class="flex justify-between items-center"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${c.type==='supplier'?'Hutang Kita':'Piutang Kita'}</p><p class="font-black ${c.balance>0?(c.type==='supplier'?'text-red-600':'text-blue-600'):'text-slate-200'}">${formatCurrency(c.balance)}</p></div><div class="pt-4 border-t flex gap-2">${c.balance>0?`<button onclick="openPaymentModal('${c.id}')" class="flex-1 py-2.5 bg-slate-900 text-white text-[10px] font-bold rounded-xl uppercase">Bayar/Cicil</button>`:''}<button onclick="deleteDoc(doc(db,'artifacts','${appId}','public','data','contacts','${c.id}'))" class="px-3 py-2.5 bg-red-50 text-red-500 rounded-xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`;
            const sList = document.getElementById('suppliers-list');
            const cList = document.getElementById('customers-list');
            if(sList) sList.innerHTML = contactsData.filter(c=>c.type==='supplier').map(card).join('');
            if(cList) cList.innerHTML = contactsData.filter(c=>c.type==='customer').map(card).join('');
            refreshIcons();
        };

        window.renderTransactions = () => {
            const sorted = transactionsData.sort((a,b)=> (b.time?.seconds || 0) - (a.time?.seconds || 0));
            const logs = document.getElementById('recent-logs');
            const body = document.getElementById('cashflow-table-body');
            if(logs) logs.innerHTML = sorted.slice(0,5).map(t => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><div><p class="font-bold text-xs">${t.note}</p><p class="text-[10px] text-slate-400">${t.time?.toDate()?.toLocaleTimeString() || ''}</p></div><span class="font-black text-xs ${t.type==='in'?'text-emerald-600':'text-rose-500'}">${t.type==='in'?'+':'-'}${formatCurrency(t.amount)}</span></div>`).join('');
            if(body) body.innerHTML = sorted.map(t => `<tr><td class="p-4 text-slate-400">${t.time?.toDate()?.toLocaleString()||'-'}</td><td class="p-4 font-medium">${t.note}</td><td class="p-4 text-center font-bold uppercase ${t.type==='in'?'text-green-600':'text-rose-500'} text-[10px]">${t.type}</td><td class="p-4 text-right font-bold">${formatCurrency(t.amount)}</td></tr>`).join('');
        };

        window.renderExpenses = () => {
            const body = document.getElementById('expenses-table-body');
            if(body) body.innerHTML = expensesData.map(e => `<tr><td class="px-5 py-4 text-[10px] text-slate-400">${e.createdAt?.toDate()?.toLocaleDateString()||'-'}</td><td class="px-5 py-4 font-bold text-rose-500 uppercase tracking-tighter">${e.category}</td><td class="px-5 py-4 text-right font-black">${formatCurrency(e.amount)}</td><td class="px-5 py-4 text-right"><button onclick="deleteDoc(doc(db,'artifacts','${appId}','public','data','expenses','${e.id}'))" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
            refreshIcons();
        };

        window.updateStats = () => {
            const vol = inventoryData.reduce((a,c)=>a+(c.unitVolume||0),0), stockVal = inventoryData.reduce((a,c)=>a+(c.totalPrice||0),0);
            const revTotal = salesData.reduce((a,c)=>a+(c.price||0),0), buyTotal = inventoryData.reduce((a,c)=>a+(c.totalPrice||0),0), expTotal = expensesData.reduce((a,c)=>a+(c.amount||0),0);
            const cin = transactionsData.filter(t=>t.type==='in').reduce((a,t)=>a+t.amount,0), cout = transactionsData.filter(t=>t.type==='out').reduce((a,t)=>a+t.amount,0);
            const dVal = contactsData.filter(c=>c.type==='supplier').reduce((a,c)=>a+(c.balance||0),0), pVal = contactsData.filter(c=>c.type==='customer').reduce((a,c)=>a+(c.balance||0),0);
            
            const mapping = { 'stat-total-volume': `${vol.toFixed(2)} m³`, 'stat-total-price': formatCurrency(stockVal), 'stat-total-debt': formatCurrency(dVal), 'stat-total-receivable': formatCurrency(pVal), 'report-total-revenue': formatCurrency(revTotal), 'report-total-cogs': formatCurrency(buyTotal), 'report-total-expenses': "- " + formatCurrency(expTotal), 'report-gross-profit-accrual': formatCurrency(revTotal - buyTotal - expTotal), 'report-cash-in': formatCurrency(cin), 'report-cash-out': formatCurrency(cout), 'report-net-cash': formatCurrency(cin - cout) };
            Object.keys(mapping).forEach(id => { const el = document.getElementById(id); if(el) el.innerText = mapping[id]; });
            const loader = document.getElementById('loading'); if(loader) loader.classList.add('hidden');
        };

        window.updateSelects = () => {
            const sS = document.getElementById('wood-supplier-select'); if(sS) sS.innerHTML = contactsData.filter(c=>c.type==='supplier').map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
            const cS = document.getElementById('sales-customer-select'); if(cS) cS.innerHTML = contactsData.filter(c=>c.type==='customer').map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            const stS = document.getElementById('sales-stock-item-select'); if(stS) stS.innerHTML = '<option value="">Pilih Stok Tersedia</option>' + inventoryData.map(i=>`<option value="${i.id}">${i.type} (${i.unitVolume.toFixed(2)} m³) - ${i.nota}</option>`).join('');
        };

        window.autoFillSalesFromStock = () => {
            const id = document.getElementById('sales-stock-item-select').value;
            const it = inventoryData.find(i=>i.id===id);
            if(it){
                document.getElementById('sales-wood-type').value = it.type;
                document.getElementById('sales-wood-vol').value = it.unitVolume;
                document.getElementById('sales-wood-price').value = it.totalPrice;
            }
        };

        // --- Database Utils ---
        window.handleBackupDatabase = async () => {
            const colls = ['inventory', 'contacts', 'sales', 'transactions', 'expenses'];
            let backup = {};
            for (const c of colls) {
                const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', c));
                backup[c] = s.docs.map(d => ({ id: d.id, ...d.data() }));
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `woodit_backup_${new Date().toISOString().slice(0,10)}.json`); dl.click();
            showToast("Berhasil mencadangkan database ke file JSON.");
        };

        window.handleRestoreDatabase = async (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const data = JSON.parse(ev.target.result); document.getElementById('loading').classList.remove('hidden');
                for (const collName of Object.keys(data)) {
                    for (const item of data[collName]) {
                        const { id, ...rest } = item;
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', collName, id), rest);
                    }
                }
                showToast("Database berhasil dipulihkan."); location.reload();
            };
            reader.readAsText(file);
        };

        window.handleResetDatabase = async () => {
            if(!confirm("Hapus seluruh data di database? Tindakan ini permanen!")) return;
            document.getElementById('loading').classList.remove('hidden');
            const colls = ['inventory', 'contacts', 'sales', 'transactions', 'expenses'];
            for (const c of colls) {
                const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', c));
                for (const d of s.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', c, d.id));
            }
            showToast("Seluruh data telah dihapus."); location.reload();
        };

        window.openPaymentModal = (cid) => { 
            const c = contactsData.find(x=>x.id===cid); 
            document.getElementById('payment-contact-id').value = cid; 
            document.getElementById('payment-current-balance').innerText = formatCurrency(c.balance); 
            document.getElementById('payment-title').innerText = c.type === 'supplier' ? 'Bayar Hutang' : 'Terima Piutang';
            openModal('payment'); 
        };
        window.toggleDPInput = (type) => { const s = document.getElementById(`${type}-payment-status`).value; document.getElementById(`${type}-dp-amount`).classList.toggle('hidden', s !== 'DP'); };
        window.deleteInventory = async (nota) => { if(confirm('Hapus nota ini?')){ const b = writeBatch(db); inventoryData.filter(i=>i.nota === nota).forEach(item => b.delete(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', item.id))); await b.commit(); showToast("Dihapus."); } };
        window.deleteSales = async (nota) => { if(confirm('Hapus SJ ini?')){ const b = writeBatch(db); salesData.filter(i=>i.nota === nota).forEach(item => b.delete(doc(db, 'artifacts', appId, 'public', 'data', 'sales', item.id))); await b.commit(); showToast("Dihapus."); } };
        window.deleteDoc = deleteDoc; window.doc = doc; window.db = db;
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // --- App Initializer ---
        const initApp = async () => {
            try {
                // Wait for anonymous auth first (Rule 3)
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) startSync(user);
                });
            } catch (err) { console.error("Auth Failure:", err); }
        };

        initApp();
        switchView('dashboard');
    </script>
</body>
</html>
