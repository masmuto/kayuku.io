<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wood-IT | Sistem Pengelolaan Kayu Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        #login-overlay { 
            position: fixed; inset: 0; z-index: 9999; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #94a3b8; transition: all 0.2s; }
        .pin-dot.active { background: #f59e0b; border-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 md:pb-0 flex flex-col md:flex-row">

    <div id="toast-container" class="fixed top-4 right-4 z-[10000] pointer-events-none"></div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="no-print">
        <div class="w-full max-w-xs p-6 text-center space-y-8">
            <div class="space-y-2">
                <div class="bg-amber-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto shadow-2xl">
                    <i data-lucide="lock" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-white text-2xl font-black tracking-tighter uppercase">Wood-IT Login</h1>
                <p id="login-status-text" class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Masukkan PIN Keamanan</p>
            </div>
            <div class="flex justify-center space-x-4 py-4">
                <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div>
                <div class="pin-dot" id="dot-3"></div><div class="pin-dot" id="dot-4"></div><div class="pin-dot" id="dot-5"></div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="pressPin(1)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">1</button>
                <button onclick="pressPin(2)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">2</button>
                <button onclick="pressPin(3)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">3</button>
                <button onclick="pressPin(4)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">4</button>
                <button onclick="pressPin(5)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">5</button>
                <button onclick="pressPin(6)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">6</button>
                <button onclick="pressPin(7)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">7</button>
                <button onclick="pressPin(8)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">8</button>
                <button onclick="pressPin(9)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 active:scale-95 transition">9</button>
                <button onclick="clearPin()" class="h-14 rounded-2xl bg-red-500/10 text-red-400 text-sm font-bold uppercase">C</button>
                <button onclick="pressPin(0)" class="h-14 rounded-2xl bg-white/5 text-white text-xl font-bold hover:bg-white/10 transition">0</button>
                <button onclick="submitPin()" class="h-14 rounded-2xl bg-amber-600 text-white text-sm font-bold uppercase">OK</button>
            </div>
            <div id="backdoor-info" class="hidden"><p class="text-[9px] text-amber-500 font-bold italic mt-4 uppercase tracking-tighter">Mode Setup: PIN 000000</p></div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:flex w-64 bg-slate-900 text-white p-6 flex-col space-y-8 no-print shrink-0 sticky top-0 h-screen overflow-y-auto">
        <div class="flex items-center space-x-3 px-2">
            <div class="bg-amber-600 p-2 rounded-lg"><i data-lucide="package" class="w-6 h-6"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">Wood-IT Log</h1>
                <p class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">Management</p>
            </div>
        </div>
        <nav class="flex-1 space-y-1">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span>Dashboard</span></button>
            <button onclick="switchView('inventory')" id="nav-inventory" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="database" class="w-5 h-5"></i> <span>Stok Log</span></button>
            <button onclick="switchView('sales')" id="nav-sales" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="shopping-cart" class="w-5 h-5"></i> <span>Kayu Keluar</span></button>
            <button onclick="switchView('expenses')" id="nav-expenses" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="receipt" class="w-5 h-5"></i> <span>Biaya Operasional</span></button>
            
            <div class="admin-only hidden pt-6 pb-2 px-4 text-[9px] font-bold text-slate-500 uppercase mt-4">Finance</div>
            <button onclick="switchView('reports')" id="nav-reports" class="nav-btn admin-only hidden w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="pie-chart" class="w-5 h-5"></i> <span>Laporan</span></button>
            <button onclick="switchView('suppliers')" id="nav-suppliers" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="truck" class="w-5 h-5"></i> <span>Supplier</span></button>
            <button onclick="switchView('customers')" id="nav-customers" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="users" class="w-5 h-5"></i> <span>Pelanggan</span></button>
            <button onclick="switchView('settings')" id="nav-settings" class="nav-btn admin-only hidden w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10 text-sm"><i data-lucide="settings" class="w-5 h-5"></i> <span>Pengaturan</span></button>
        </nav>
        <div class="pt-6 border-t border-white/10">
            <div id="user-display-name" class="text-xs font-bold text-slate-300 px-2 truncate mb-1">...</div>
            <div id="user-role-badge" class="text-[9px] font-bold uppercase tracking-tighter px-2 py-0.5 rounded bg-amber-600/20 text-amber-500 mb-4 inline-block">-</div>
            <button onclick="lockSystem()" class="w-full flex items-center justify-center space-x-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition text-xs font-bold uppercase"><i data-lucide="lock" class="w-4 h-4"></i> <span>Kunci</span></button>
        </div>
    </aside>

    <!-- Bottom Nav Mobile -->
    <nav id="bottom-nav" class="hidden md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-white/5 flex justify-around p-2 z-[50] pb-safe no-print">
        <button onclick="switchView('dashboard')" class="text-slate-400 p-2"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></button>
        <button onclick="switchView('inventory')" class="text-slate-400 p-2"><i data-lucide="database" class="w-5 h-5"></i></button>
        <button onclick="switchView('sales')" class="text-slate-400 p-2"><i data-lucide="shopping-cart" class="w-5 h-5"></i></button>
        <button onclick="switchView('expenses')" class="text-slate-400 p-2"><i data-lucide="receipt" class="w-5 h-5"></i></button>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-10 overflow-y-auto w-full">
        <div id="loading" class="fixed inset-0 bg-white/80 z-[100] flex items-center justify-center no-print">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-600"></div>
        </div>

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="space-y-6 md:space-y-8 no-print">
            <header>
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 tracking-tight">Ringkasan Operasional</h2>
                <p class="text-xs text-slate-500">Monitoring volume dan keuangan terkini.</p>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider mb-1">Volume Stok</p>
                    <p class="text-2xl font-black text-slate-900" id="stat-total-volume">0.00 m続</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider mb-1">Nilai Inventaris</p>
                    <p class="text-2xl font-black text-slate-900" id="stat-total-price">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider mb-1">Hutang</p>
                    <p class="text-2xl font-black text-red-600" id="stat-total-debt">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider mb-1">Piutang</p>
                    <p class="text-2xl font-black text-blue-600" id="stat-total-receivable">Rp 0</p>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center space-x-2 text-sm"><i data-lucide="history" class="w-4 h-4 text-amber-600"></i> <span>Aktivitas Terakhir</span></h3>
                <div id="recent-logs" class="space-y-3"></div>
            </div>
        </section>

        <!-- STOK LOG (INVENTORY) -->
        <section id="view-inventory" class="hidden space-y-6">
             <header class="flex justify-between items-center"><h2 class="text-xl font-bold text-slate-800">Stok Kayu Log</h2><button onclick="openModal('wood')" class="bg-amber-600 text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-lg">INPUT NOTA</button></header>
             <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-x-auto">
                 <table class="w-full text-left text-xs min-w-[600px]">
                     <thead class="bg-slate-50 border-b">
                         <tr><th class="px-6 py-4">Nota</th><th class="px-6 py-4">Supplier</th><th class="px-6 py-4 text-center">Volume (m続)</th><th class="px-6 py-4 text-right">Nilai</th><th class="px-6 py-4 text-right">Aksi</th></tr>
                     </thead>
                     <tbody id="inventory-table-body" class="divide-y divide-slate-50"></tbody>
                 </table>
             </div>
        </section>

        <!-- KAYU KELUAR -->
        <section id="view-sales" class="hidden space-y-6">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold text-slate-800">Kayu Keluar</h2><button onclick="openModal('sales')" class="bg-blue-600 text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-lg">INPUT PENGIRIMAN</button></header>
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-x-auto">
                <table class="w-full text-left text-xs min-w-[600px]">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="px-6 py-4">SJ / Nota</th><th class="px-6 py-4">Pelanggan</th><th class="px-6 py-4 text-center">Volume (m続)</th><th class="px-6 py-4 text-right">Total</th><th class="px-6 py-4 text-right">Aksi</th></tr>
                    </thead>
                    <tbody id="sales-table-body" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </section>

        <!-- KONTAK -->
        <section id="view-suppliers" class="hidden space-y-6">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold">Supplier</h2><button onclick="openModal('contact', 'supplier')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-bold uppercase">Tambah</button></header>
            <div id="suppliers-list" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </section>
        <section id="view-customers" class="hidden space-y-6">
            <header class="flex justify-between items-center"><h2 class="text-xl font-bold">Pelanggan</h2><button onclick="openModal('contact', 'customer')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-bold uppercase">Tambah</button></header>
            <div id="customers-list" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </section>

        <!-- PENGATURAN -->
        <section id="view-settings" class="hidden space-y-6 admin-only">
             <header><h2 class="text-2xl font-bold">Pengaturan</h2></header>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
                 <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6">
                     <div class="flex justify-between items-center"><h3 class="font-bold text-sm uppercase">User Manager</h3><button onclick="openModal('user-manager')" class="bg-amber-600 text-white px-4 py-2 rounded-xl text-[9px] font-bold">TAMBAH USER</button></div>
                     <div class="border rounded-2xl overflow-hidden">
                         <table class="w-full text-left text-[11px]">
                             <thead class="bg-slate-50"><tr><th class="px-4 py-3">Nama</th><th class="px-4 py-3">Role</th><th class="px-4 py-3 text-right">Aksi</th></tr></thead>
                             <tbody id="user-manager-list" class="divide-y divide-slate-50"></tbody>
                         </table>
                     </div>
                 </div>
                 <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6">
                     <h3 class="font-bold text-sm text-rose-600 uppercase tracking-tighter">Database</h3>
                     <div class="grid grid-cols-1 gap-3">
                         <button onclick="handleBackupDatabase()" class="w-full py-3 bg-slate-900 text-white rounded-2xl text-xs font-bold uppercase">Backup ke JSON</button>
                         <button onclick="handleResetDatabase()" class="w-full py-3 bg-rose-50 text-rose-600 border border-rose-100 rounded-2xl text-xs font-bold mt-4 uppercase">Reset Sistem</button>
                     </div>
                 </div>
             </div>
        </section>
    </main>

    <!-- MODAL USER MANAGER -->
    <div id="user-manager-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 space-y-6 shadow-2xl">
            <h3 class="font-black text-sm uppercase text-slate-800 tracking-tighter">Tambah Pengguna</h3>
            <form onsubmit="handleUserSubmit(event)" class="space-y-4">
                <input type="text" id="user-name" placeholder="Nama Lengkap" class="w-full p-4 rounded-2xl border text-sm font-bold" required>
                <select id="user-role" class="w-full p-4 rounded-2xl border text-sm font-bold"><option value="Admin">Admin</option><option value="Kasir">Kasir</option></select>
                <input type="password" maxlength="6" id="user-pin" placeholder="PIN 6 Digit" class="w-full p-4 rounded-2xl border text-sm tracking-widest text-center font-mono font-black" required>
                <button type="submit" class="w-full py-4 bg-amber-600 text-white rounded-2xl font-black shadow-xl uppercase text-xs tracking-widest">Simpan User</button>
                <button type="button" onclick="closeModal('user-manager')" class="w-full py-2 text-slate-400 text-[10px] font-black uppercase tracking-widest text-center block w-full">Batal</button>
            </form>
        </div>
    </div>

    <!-- MODAL KONTAK (SUPPLIER/CUSTOMER) -->
    <div id="contact-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 space-y-6 shadow-2xl">
            <h3 class="font-black text-sm uppercase text-slate-800 tracking-tighter">Tambah Kontak</h3>
            <form onsubmit="handleContactSubmit(event)" class="space-y-4">
                <input type="hidden" id="contact-type">
                <input type="text" id="contact-name" placeholder="Nama" class="w-full p-4 rounded-2xl border text-sm font-bold" required>
                <button type="submit" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black shadow-xl uppercase text-xs tracking-widest">Simpan Kontak</button>
                <button type="button" onclick="closeModal('contact')" class="w-full py-2 text-slate-400 text-[10px] font-black uppercase tracking-widest text-center block w-full">Batal</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, serverTimestamp, writeBatch, increment, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = { apiKey: "AIzaSyD8m4HiTateYgP-79EmbKkqOG-lBIeikBc", authDomain: "log-master-687fd.firebaseapp.com", projectId: "log-master-687fd", storageBucket: "log-master-687fd.firebasestorage.app", messagingSenderId: "1020351029888", appId: "1:1020351029888:web:47706ebb73f446207b7c65" };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const appId = "log-master-system";

        let currentPin = "", usersData = [], loggedInUser = null;
        let inventoryData = [], contactsData = [], transactionsData = [], salesData = [];

        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        
        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 mb-2 rounded-2xl text-white text-[10px] font-black shadow-2xl pointer-events-auto transition-all ${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'}`;
            toast.innerText = msg; container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
        };

        // --- AUTH & LOGIN SYSTEM ---
        window.pressPin = (n) => { if (currentPin.length < 6) { currentPin += n; updatePinDots(); } };
        window.clearPin = () => { currentPin = ""; updatePinDots(); };
        const updatePinDots = () => {
            for (let i = 0; i < 6; i++) { document.getElementById(`dot-${i}`).classList.toggle('active', i < currentPin.length); }
        };

        window.submitPin = async () => {
            const pinStr = String(currentPin).trim();
            const hasAdmin = usersData.some(u => u.role && u.role.toLowerCase() === 'admin');
            
            console.log("PIN ATTEMPT:", pinStr, "| HAS ADMIN:", hasAdmin);

            // BACKDOOR: 000000 aktif jika admin belum terdaftar sama sekali
            if (pinStr === "000000" && !hasAdmin) {
                handleLoginSuccess({ name: "SETUP MASTER", role: "Admin", isBackdoor: true });
                return;
            }

            const match = usersData.find(u => u.pin === pinStr);
            if (match) {
                handleLoginSuccess(match);
            } else {
                showToast("PIN SALAH!", "error");
                clearPin();
            }
        };

        const handleLoginSuccess = (user) => {
            loggedInUser = user;
            // Sembunyikan Overlay Login
            document.getElementById('login-overlay').style.display = 'none';
            
            // Tampilkan Sidebar & Navigasi
            const sidebar = document.getElementById('sidebar');
            const bNav = document.getElementById('bottom-nav');
            sidebar.classList.remove('hidden'); sidebar.classList.add('flex');
            bNav.classList.remove('hidden'); bNav.classList.add('flex');

            document.getElementById('user-display-name').innerText = user.name;
            document.getElementById('user-role-badge').innerText = user.role;
            
            // Hak akses Admin
            const isAdmin = user.role.toLowerCase() === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => {
                if (isAdmin) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            showToast(`SELAMAT DATANG: ${user.name}`);
            switchView('dashboard');
            refreshIcons();
        };

        window.lockSystem = () => { location.reload(); };

        // --- NAVIGATION ---
        window.switchView = (v) => {
            if (!loggedInUser) return;
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`view-${v}`);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-amber-600', 'text-white'));
            const btn = document.getElementById(`nav-${v}`); if (btn) btn.classList.add('bg-amber-600', 'text-white');
            
            refreshIcons();
        };

        window.openModal = (id, sub = '') => {
            if (id === 'contact') document.getElementById('contact-type').value = sub;
            document.getElementById(`${id}-modal`).classList.remove('hidden');
        };
        window.closeModal = (id) => document.getElementById(`${id}-modal`).classList.add('hidden');

        // --- DATA SYNC ---
        const startSync = () => {
            // USERS
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), s => {
                usersData = s.docs.map(d => ({ id: d.id, ...d.data() }));
                const hasAdmin = usersData.some(u => u.role && u.role.toLowerCase() === 'admin');
                document.getElementById('backdoor-info').classList.toggle('hidden', hasAdmin);
                if (!hasAdmin) document.getElementById('login-status-text').innerText = "MODE SETUP: PIN 000000";
                
                const list = document.getElementById('user-manager-list');
                if(list) list.innerHTML = usersData.map(u => `<tr><td class="p-4 font-bold text-slate-700">${u.name}</td><td class="p-4 uppercase text-slate-500 font-bold">${u.role}</td><td class="p-4 text-right"><button onclick="deleteDoc(doc(db,'artifacts','${appId}','public','data','users','${u.id}'))" class="text-rose-500 font-bold uppercase text-[9px]">Hapus</button></td></tr>`).join('');
                refreshIcons();
            });

            // INVENTORY
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), s => {
                inventoryData = s.docs.map(d=>({id:d.id, ...d.data()}));
                const g = inventoryData.reduce((acc, i) => { if(!acc[i.nota]) acc[i.nota] = { ...i, v:0, p:0 }; acc[i.nota].v += (i.unitVolume||0); acc[i.nota].p += (i.totalPrice||0); return acc; }, {});
                document.getElementById('inventory-table-body').innerHTML = Object.values(g).map(n => `<tr><td class="px-6 py-4 font-black text-blue-600">${n.nota}</td><td class="px-6 py-4 font-bold">${contactsData.find(c=>c.id===n.supplierId)?.name||'-'}</td><td class="px-6 py-4 text-center font-bold">${n.v.toFixed(2)}</td><td class="px-6 py-4 text-right font-black">${formatCurrency(n.p)}</td><td class="px-6 py-4 text-right"><button class="text-slate-400"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button></td></tr>`).join('');
                updateStats();
            });

            // CONTACTS
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), s => {
                contactsData = s.docs.map(d=>({id:d.id, ...d.data()}));
                const card = (c) => `
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4">
                        <div class="flex justify-between items-start">
                            <div class="p-4 bg-slate-100 rounded-3xl"><i data-lucide="${c.type === 'supplier' ? 'truck' : 'user'}" class="w-5 h-5 text-slate-600"></i></div>
                            <div class="text-right">
                                <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest">${c.type==='supplier'?'Hutang':'Piutang'}</p>
                                <p class="font-black text-lg ${c.balance>0?(c.type==='supplier'?'text-rose-600':'text-blue-600'):'text-slate-200'}">${formatCurrency(c.balance)}</p>
                            </div>
                        </div>
                        <h4 class="font-black text-slate-900 text-sm uppercase tracking-tighter">${c.name}</h4>
                        <div class="pt-4 border-t border-slate-50 flex gap-2">
                            <button onclick="if(confirm('Hapus kontak?')) deleteDoc(doc(db,'artifacts','${appId}','public','data','contacts','${c.id}'))" class="px-3 py-2 bg-rose-50 text-rose-500 rounded-xl transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                document.getElementById('suppliers-list').innerHTML = contactsData.filter(c => c.type === 'supplier').map(card).join('');
                document.getElementById('customers-list').innerHTML = contactsData.filter(c => c.type === 'customer').map(card).join('');
                refreshIcons(); updateStats();
            });
        };

        const updateStats = () => {
            const v = inventoryData.reduce((a,c)=>a+(c.unitVolume||0),0);
            const p = inventoryData.reduce((a,c)=>a+(c.totalPrice||0),0);
            document.getElementById('stat-total-volume').innerText = `${v.toFixed(2)} m続`;
            document.getElementById('stat-total-price').innerText = formatCurrency(p);
            document.getElementById('loading').classList.add('hidden');
        };

        onAuthStateChanged(auth, u => { if(u) startSync(); });
        signInAnonymously(auth);
    </script>
</body>
</html>
