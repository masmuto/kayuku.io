<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wood-IT | Sistem Pengelolaan Kayu Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Library untuk Ekspor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }

        /* Navigasi Aktif */
        .nav-active { @apply bg-amber-600 text-white shadow-lg shadow-amber-900/20; }
        
        /* Toast Animation */
        #toast-container { position: fixed; top: 20px; right: 20px; left: 20px; z-index: 9999; pointer-events: none; }
        @media (min-width: 768px) { #toast-container { left: auto; width: 350px; } }
        .toast { animation: slideIn 0.3s ease-out forwards; pointer-events: auto; }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Mobile Adjustments */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 md:pb-0">

    <div id="toast-container"></div>

    <div id="app" class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex w-64 bg-slate-900 text-white p-6 flex-col space-y-8 no-print shrink-0 sticky top-0 h-screen">
            <div class="flex items-center space-x-3 px-2">
                <div class="bg-amber-600 p-2 rounded-lg"><i data-lucide="package" class="w-6 h-6"></i></div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight" id="sidebar-company-name">Wood-IT Log</h1>
                    <p class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">Management System</p>
                </div>
            </div>

            <nav class="flex-1 space-y-1 overflow-y-auto custom-nav">
                <button onclick="switchView('dashboard')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </button>
                <button onclick="switchView('inventory')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-inventory">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span>Stok Log</span>
                </button>
                <button onclick="switchView('sales')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-sales">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span>Kayu Keluar</span>
                </button>
                <button onclick="switchView('expenses')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-expenses">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    <span>Biaya & Beban</span>
                </button>
                <div class="admin-only hidden pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Keuangan</div>
                <button onclick="switchView('reports')" class="nav-btn admin-only hidden w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-reports">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                    <span>Laporan</span>
                </button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sistem</div>
                <button onclick="switchView('suppliers')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-suppliers">
                    <i data-lucide="truck" class="w-5 h-5"></i>
                    <span>Supplier</span>
                </button>
                <button onclick="switchView('customers')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-customers">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Pelanggan</span>
                </button>
                <button onclick="switchView('settings')" class="nav-btn admin-only hidden w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition hover:bg-white/10" id="nav-settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Pengaturan</span>
                </button>
            </nav>

            <div class="pt-6 border-t border-white/10">
                <div id="user-role-badge" class="text-[9px] font-bold uppercase tracking-tighter px-2 py-0.5 rounded bg-slate-800 text-slate-500 mb-4 inline-block">-</div>
                <button onclick="handleLogout()" class="w-full flex items-center justify-center space-x-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Navigasi Bawah (Mobile) -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-white/5 flex items-center justify-around p-2 z-50 safe-bottom no-print">
            <button onclick="switchView('dashboard')" class="mobile-nav-btn flex flex-col items-center p-2 text-slate-400" id="mob-nav-dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1">Home</span>
            </button>
            <button onclick="switchView('inventory')" class="mobile-nav-btn flex flex-col items-center p-2 text-slate-400" id="mob-nav-inventory">
                <i data-lucide="database" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1">Stok</span>
            </button>
            <button onclick="switchView('sales')" class="mobile-nav-btn flex flex-col items-center p-2 text-slate-400" id="mob-nav-sales">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1">Keluar</span>
            </button>
            <button onclick="switchView('expenses')" class="mobile-nav-btn flex flex-col items-center p-2 text-slate-400" id="mob-nav-expenses">
                <i data-lucide="receipt" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1">Biaya</span>
            </button>
            <button onclick="toggleMobileMenu()" class="mobile-nav-btn flex flex-col items-center p-2 text-slate-400">
                <i data-lucide="menu" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1">Menu</span>
            </button>
        </nav>

        <!-- Menu Mobile Overlay -->
        <div id="mobile-extra-menu" class="fixed inset-0 bg-slate-900/95 z-[60] hidden flex-col p-8 transition-all no-print">
            <div class="flex justify-end mb-8"><button onclick="toggleMobileMenu()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button></div>
            <div class="space-y-6">
                <button onclick="switchView('reports'); toggleMobileMenu()" class="admin-only hidden w-full flex items-center space-x-4 text-white text-lg font-medium"><i data-lucide="pie-chart"></i> <span>Laporan Keuangan</span></button>
                <button onclick="switchView('suppliers'); toggleMobileMenu()" class="w-full flex items-center space-x-4 text-white text-lg font-medium"><i data-lucide="truck"></i> <span>Data Supplier</span></button>
                <button onclick="switchView('customers'); toggleMobileMenu()" class="w-full flex items-center space-x-4 text-white text-lg font-medium"><i data-lucide="users"></i> <span>Data Pelanggan</span></button>
                <button onclick="switchView('settings'); toggleMobileMenu()" class="admin-only hidden w-full flex items-center space-x-4 text-white text-lg font-medium"><i data-lucide="settings"></i> <span>Pengaturan Sistem</span></button>
                <div class="pt-8 border-t border-white/10">
                    <button onclick="handleLogout()" class="w-full flex items-center space-x-4 text-red-400 text-lg font-medium"><i data-lucide="log-out"></i> <span>Keluar Aplikasi</span></button>
                </div>
            </div>
        </div>

        <!-- Konten Utama -->
        <main class="flex-1 p-4 md:p-10 overflow-y-auto">
            <div id="loading" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center transition-opacity no-print">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-600"></div>
            </div>

            <!-- Dashboard -->
            <section id="view-dashboard" class="space-y-6 md:space-y-8 no-print">
                <header class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800" id="welcome-title">Ringkasan Operasional</h2>
                        <p class="text-xs md:text-sm text-slate-500">Update real-time volume dan keuangan.</p>
                    </div>
                    <div class="md:hidden bg-amber-100 p-2 rounded-lg text-amber-600"><i data-lucide="package" class="w-5 h-5"></i></div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 md:block">
                        <div class="p-3 bg-amber-100 text-amber-600 rounded-xl md:mb-4"><i data-lucide="boxes" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wider">Total Volume</h3>
                            <p class="text-lg md:text-2xl font-bold text-slate-900" id="stat-total-volume">0.00 m³</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 md:block">
                        <div class="p-3 bg-green-100 text-green-600 rounded-xl md:mb-4"><i data-lucide="wallet" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wider">Nilai Stok</h3>
                            <p class="text-lg md:text-2xl font-bold text-slate-900" id="stat-total-price">Rp 0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 md:block">
                        <div class="p-3 bg-red-100 text-red-600 rounded-xl md:mb-4"><i data-lucide="arrow-up-right" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wider">Hutang</h3>
                            <p class="text-lg md:text-2xl font-bold text-red-600" id="stat-total-debt">Rp 0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 md:block">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-xl md:mb-4"><i data-lucide="arrow-down-left" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-slate-500 text-[10px] md:text-sm font-medium uppercase tracking-wider">Piutang</h3>
                            <p class="text-lg md:text-2xl font-bold text-blue-600" id="stat-total-receivable">Rp 0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 overflow-hidden">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center space-x-2"><i data-lucide="activity" class="w-4 h-4"></i> <span>Aktivitas Kas Terbaru</span></h3>
                    <div id="recent-logs" class="space-y-4">
                        <p class="italic text-slate-400 text-sm">Belum ada aktivitas tercatat.</p>
                    </div>
                </div>
            </section>

            <!-- Laporan Keuangan -->
            <section id="view-reports" class="hidden space-y-6 md:space-y-8 no-print">
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Laporan Keuangan</h2><p class="text-xs md:text-sm text-slate-500">Analisis laba rugi dan kas.</p></div>
                    <div class="flex space-x-2">
                        <button onclick="exportToExcel()" class="flex-1 md:flex-none flex items-center justify-center space-x-2 bg-emerald-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span>Excel</span></button>
                        <button onclick="exportToPDF()" class="flex-1 md:flex-none flex items-center justify-center space-x-2 bg-rose-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold"><i data-lucide="file-text" class="w-4 h-4"></i> <span>PDF</span></button>
                    </div>
                </header>

                <div id="report-content-to-export" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 md:p-8 space-y-6">
                            <h3 class="font-bold text-slate-800 flex items-center space-x-2"><i data-lucide="trending-up" class="w-5 h-5 text-blue-500"></i> <span>Laporan Laba Rugi</span></h3>
                            <div class="space-y-4 divide-y divide-slate-50 text-sm">
                                <div class="flex justify-between py-2"><span class="text-slate-500">Total Penjualan</span><span class="font-bold text-slate-900" id="report-total-revenue">Rp 0</span></div>
                                <div class="flex justify-between py-2"><span class="text-slate-500">Total Pembelian</span><span class="font-bold text-red-500" id="report-total-cogs">Rp 0</span></div>
                                <div class="flex justify-between py-2"><span class="text-slate-500">Total Biaya & Beban</span><span class="font-bold text-red-400" id="report-total-expenses">Rp 0</span></div>
                                <div class="flex justify-between py-4 border-t-2 border-slate-100"><span class="font-bold text-slate-800 uppercase text-xs">Laba Bersih Kas</span><span class="font-black text-lg text-blue-700" id="report-realized-profit">Rp 0</span></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 md:p-8 space-y-6">
                            <h3 class="font-bold text-slate-800 flex items-center space-x-2"><i data-lucide="dollar-sign" class="w-5 h-5 text-green-500"></i> <span>Ringkasan Kas</span></h3>
                            <div class="space-y-4 divide-y divide-slate-50 text-sm">
                                <div class="flex justify-between py-2"><span class="text-slate-500">Uang Masuk</span><span class="font-bold text-green-600" id="report-cash-in">Rp 0</span></div>
                                <div class="flex justify-between py-2"><span class="text-slate-500">Uang Keluar</span><span class="font-bold text-orange-600" id="report-cash-out">Rp 0</span></div>
                                <div class="flex justify-between py-4 border-t-2 border-slate-100"><span class="font-bold text-slate-800 uppercase text-xs">Saldo Kas Saat Ini</span><span class="font-black text-lg text-blue-800" id="report-net-cash">Rp 0</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-50"><h3 class="font-bold text-slate-800 text-sm">Detail Transaksi Kas</h3></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-xs md:text-sm"><thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold"><tr><th class="px-5 py-4">Waktu</th><th class="px-5 py-4">Keterangan</th><th class="px-5 py-4">Tipe</th><th class="px-5 py-4 text-right">Nominal</th></tr></thead><tbody id="cashflow-table-body" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </section>

            <!-- Stok Log -->
            <section id="view-inventory" class="hidden space-y-6 no-print">
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Stok Kayu Log</h2><p class="text-xs md:text-sm text-slate-500">Inventaris kayu tersedia.</p></div>
                    <div class="grid grid-cols-2 md:flex gap-2">
                        <button onclick="exportInventoryToExcel()" class="flex items-center justify-center space-x-2 bg-emerald-50 text-emerald-700 px-4 py-2.5 rounded-xl text-xs font-bold border border-emerald-100"><i data-lucide="download" class="w-4 h-4"></i> <span>Excel</span></button>
                        <button onclick="openModal('wood')" class="bg-amber-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold shadow-lg shadow-amber-900/10">Input Nota Baru</button>
                    </div>
                </header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold"><tr><th class="px-5 py-4">No. Nota</th><th class="px-5 py-4">Supplier</th><th class="px-5 py-4 text-center">Status</th><th class="px-5 py-4 text-center">Vol (m³)</th><th class="px-5 py-4 text-right">Nilai</th><th class="px-5 py-4 text-right no-print">Aksi</th></tr></thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Kayu Keluar -->
            <section id="view-sales" class="hidden space-y-6 no-print">
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Kayu Keluar</h2><p class="text-xs md:text-sm text-slate-500">Log pengiriman & penjualan.</p></div>
                    <button onclick="openModal('sales')" class="w-full md:w-auto bg-blue-600 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-900/10">Input Kayu Keluar</button>
                </header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold"><tr><th class="px-5 py-4">Nota / SJ</th><th class="px-5 py-4">Pelanggan</th><th class="px-5 py-4 text-center">Status</th><th class="px-5 py-4 text-center">Vol (m³)</th><th class="px-5 py-4 text-right">Total</th><th class="px-5 py-4 text-right">Aksi</th></tr></thead>
                            <tbody id="sales-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Biaya & Beban -->
            <section id="view-expenses" class="hidden space-y-6 no-print">
                <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Biaya & Beban</h2><p class="text-xs md:text-sm text-slate-500">Operasional harian.</p></div>
                    <button onclick="openModal('expense')" class="w-full md:w-auto bg-rose-500 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-rose-900/10">Input Biaya</button>
                </header>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="bg-slate-50 text-slate-500 uppercase text-[9px] font-bold"><tr><th class="px-5 py-4">Tgl</th><th class="px-5 py-4">Kategori</th><th class="px-5 py-4">Ket</th><th class="px-5 py-4 text-right">Nominal</th><th class="px-5 py-4 text-right">Aksi</th></tr></thead>
                            <tbody id="expenses-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Kontak (Suppliers & Customers) -->
            <section id="view-suppliers" class="hidden space-y-6 no-print pb-10">
                <header class="flex items-center justify-between"><h2 class="text-xl md:text-2xl font-bold text-slate-800">Supplier</h2><button onclick="openModal('contact', 'supplier')" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl text-xs font-bold">Tambah</button></header>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="suppliers-list"></div>
            </section>

            <section id="view-customers" class="hidden space-y-6 no-print pb-10">
                <header class="flex items-center justify-between"><h2 class="text-xl md:text-2xl font-bold text-slate-800">Pelanggan</h2><button onclick="openModal('contact', 'customer')" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl text-xs font-bold">Tambah</button></header>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="customers-list"></div>
            </section>

            <!-- Pengaturan -->
            <section id="view-settings" class="hidden space-y-8 no-print pb-10">
                <header><h2 class="text-xl md:text-2xl font-bold text-slate-800">Pengaturan</h2></header>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                        <h3 class="font-bold text-slate-800 flex items-center space-x-2"><i data-lucide="building-2" class="w-4 h-4"></i> <span>Profil Bisnis</span></h3>
                        <div class="space-y-4">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Nama Perusahaan</label><input type="text" id="setting-company-name" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm"></div>
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Alamat</label><textarea id="setting-company-address" rows="2" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm"></textarea></div>
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Telepon</label><input type="text" id="setting-company-phone" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm"></div>
                            <button onclick="saveCompanyProfile()" class="w-full py-3 bg-amber-600 text-white rounded-xl font-bold text-sm">Simpan</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                        <h3 class="font-bold text-slate-800 flex items-center space-x-2"><i data-lucide="database" class="w-4 h-4 text-rose-500"></i> <span>Data Management</span></h3>
                        <div class="space-y-3">
                            <button onclick="handleBackupDatabase()" class="w-full flex items-center justify-center space-x-2 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm"><i data-lucide="download" class="w-4 h-4"></i> <span>Backup ke JSON</span></button>
                            <div class="pt-4 border-t"><button onclick="handleResetDatabase()" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold text-sm border border-red-100">Reset Semua Data</button></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals (Tetap fungsional dan responsif) -->
    <!-- Input Wood Modal -->
    <div id="wood-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-2 md:p-4 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl flex flex-col max-h-[95vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10"><h3 id="wood-modal-title" class="font-bold text-slate-800 uppercase tracking-tight text-sm">Input Log Baru</h3><button onclick="closeModal('wood')" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-5 rounded-2xl">
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">No. Nota</label><input type="text" id="wood-nota" placeholder="INV-001" class="w-full p-3 rounded-xl border bg-white text-sm"></div>
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Supplier</label><select id="wood-supplier-select" class="w-full p-3 rounded-xl border bg-white text-sm"></select></div>
                    <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Total Harga Nota</label><input type="number" id="wood-total-nota-price" placeholder="0" class="w-full p-3 rounded-xl border bg-white text-sm font-bold text-amber-700"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-amber-50 p-5 rounded-2xl border border-amber-100">
                    <select id="wood-payment-status" onchange="toggleDPInput('wood')" class="p-3 rounded-xl border bg-white text-sm"><option value="Hutang">Hutang</option><option value="Lunas">Lunas</option><option value="DP">DP</option></select>
                    <input type="number" id="wood-dp-amount" placeholder="Nominal DP" class="hidden p-3 rounded-xl border bg-white text-sm">
                </div>
                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-4 md:p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Jenis Kayu</label><input type="text" id="wood-type" class="w-full p-3 rounded-xl border text-sm" placeholder="Jati, dll"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Panjang (cm)</label><input type="number" id="log-p" oninput="liveUpdateCalc()" class="w-full p-3 rounded-xl border text-sm" placeholder="200"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">No LOG</label><input type="text" id="log-no" class="w-full p-3 rounded-xl border text-sm" placeholder="Tag"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Grade</label><input type="text" id="log-grade" class="w-full p-3 rounded-xl border text-sm" placeholder="A1, B"></div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold uppercase text-slate-400 ml-1 text-center block">Diameter d1 - d4 (cm)</label>
                        <div class="grid grid-cols-4 gap-2">
                            <input type="number" id="log-d1" oninput="liveUpdateCalc()" class="p-2.5 rounded-lg border text-center text-sm" placeholder="d1">
                            <input type="number" id="log-d2" oninput="liveUpdateCalc()" class="p-2.5 rounded-lg border text-center text-sm" placeholder="d2">
                            <input type="number" id="log-d3" oninput="liveUpdateCalc()" class="p-2.5 rounded-lg border text-center text-sm" placeholder="d3">
                            <input type="number" id="log-d4" oninput="liveUpdateCalc()" class="p-2.5 rounded-lg border text-center text-sm" placeholder="d4">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">Trim (cm)</label><input type="number" id="log-trim" oninput="liveUpdateCalc()" class="w-full p-3 rounded-xl border text-sm" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold uppercase text-slate-400 ml-1">GR (cm)</label><input type="number" id="log-gr" oninput="liveUpdateCalc()" class="w-full p-3 rounded-xl border text-sm" placeholder="0"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 bg-slate-900 text-white p-3 rounded-xl">
                        <div class="text-center"><span class="text-[8px] uppercase font-bold text-slate-500">Rata D</span><div class="text-xs font-bold" id="res-live-avg-d">0 cm</div></div>
                        <div class="text-center"><span class="text-[8px] uppercase font-bold text-slate-500">Vol GR</span><div class="text-xs font-bold" id="res-live-vol-gr">0.00</div></div>
                        <div class="text-center"><span class="text-[8px] uppercase font-bold text-slate-500">Neto</span><div class="text-xs font-bold" id="res-live-vol-wood">0.00</div></div>
                    </div>
                    <button onclick="addItemToBatch('wood')" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm">Tambah Ke Batch</button>
                </div>
                <div class="border rounded-2xl overflow-hidden"><table class="w-full text-[10px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-left">No LOG</th><th class="p-3 text-left">Jenis</th><th class="p-3 text-center">Neto</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="wood-batch-table"></tbody></table></div>
            </div>
            <div class="p-5 border-t flex space-x-3 bg-slate-50"><button onclick="closeModal('wood')" class="flex-1 py-3 rounded-xl border text-sm">Batal</button><button onclick="submitBatchToFirebase()" id="btn-save-batch-wood" disabled class="flex-1 py-3 rounded-xl bg-slate-900 text-white font-bold text-sm disabled:opacity-50">Simpan Nota</button></div>
        </div>
    </div>

    <!-- Modal Kayu Keluar & Biaya (Singkat saja karena sudah responsif) -->
    <div id="sales-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-2 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 space-y-6">
            <h3 class="font-bold text-slate-800 uppercase text-sm">Input Kayu Keluar</h3>
            <div class="space-y-4">
                <input type="text" id="sales-nota" placeholder="SJ/2025/001" class="w-full p-3 rounded-xl border text-sm">
                <select id="sales-customer-select" class="w-full p-3 rounded-xl border text-sm"></select>
                <div class="border-2 border-dashed border-slate-200 p-4 rounded-xl space-y-4">
                    <select id="sales-stock-item-select" onchange="autoFillSalesFromStock()" class="w-full p-3 rounded-xl border text-sm"></select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="sales-wood-type" placeholder="Jenis" class="p-3 rounded-xl border text-sm">
                        <input type="number" id="sales-wood-vol" placeholder="Volume" class="p-3 rounded-xl border text-sm">
                    </div>
                    <input type="number" id="sales-wood-price" placeholder="Harga Jual" class="w-full p-3 rounded-xl border text-sm">
                    <button onclick="addItemToBatch('sales')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-xs">+ Tambah Item</button>
                </div>
                <div class="border rounded-xl overflow-hidden max-h-40 overflow-y-auto"><table class="w-full text-[10px]"><tbody id="sales-batch-table"></tbody></table></div>
            </div>
            <div class="flex space-x-2 pt-4"><button onclick="closeModal('sales')" class="flex-1 py-3 border rounded-xl text-sm">Batal</button><button onclick="submitBatchSalesToFirebase()" id="btn-save-batch-sales" disabled class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm">Simpan</button></div>
        </div>
    </div>

    <!-- Expense & Contact Modals (tetap ada di index.html tapi di-style agar responsif) -->
    <div id="expense-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4">
            <h3 class="font-bold text-slate-800 text-sm">BIAYA & BEBAN</h3>
            <form id="expense-form" onsubmit="handleExpenseSubmit(event)" class="space-y-4">
                <select id="expense-category" class="w-full p-3 rounded-xl border text-sm" required><option value="Operasional">Operasional</option><option value="Gaji">Gaji</option><option value="Solar">Solar</option><option value="Lain-lain">Lain-lain</option></select>
                <input type="number" id="expense-amount" placeholder="Nominal" class="w-full p-3 rounded-xl border text-sm" required>
                <textarea id="expense-note" placeholder="Keterangan" class="w-full p-3 rounded-xl border text-sm"></textarea>
                <button type="submit" class="w-full py-3 bg-rose-500 text-white rounded-xl font-bold">Simpan</button>
                <button type="button" onclick="closeModal('expense')" class="w-full py-3 text-slate-400 text-sm">Batal</button>
            </form>
        </div>
    </div>

    <div id="contact-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-900/60 no-print">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4">
            <h3 id="contact-modal-title" class="font-bold text-slate-800 text-sm">KONTAK</h3>
            <form id="contact-form" onsubmit="handleContactSubmit(event)" class="space-y-4">
                <input type="hidden" id="contact-type">
                <input type="text" id="contact-name" placeholder="Nama" class="w-full p-3 rounded-xl border text-sm" required>
                <input type="text" id="contact-phone" placeholder="Telepon" class="w-full p-3 rounded-xl border text-sm">
                <textarea id="contact-address" placeholder="Alamat" class="w-full p-3 rounded-xl border text-sm"></textarea>
                <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">Simpan</button>
                <button type="button" onclick="closeModal('contact')" class="w-full py-3 text-slate-400 text-sm">Batal</button>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-2 bg-slate-900/60 backdrop-blur-sm overflow-y-auto no-print">
        <div class="bg-white w-full max-w-3xl rounded-3xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b flex justify-between items-center"><h3 id="detail-title" class="font-bold text-slate-800 text-xs uppercase">Detail Transaksi</h3><button onclick="closeModal('detail')" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="p-5 overflow-y-auto space-y-6">
                <div id="detail-metadata" class="grid grid-cols-2 gap-3 bg-slate-50 p-4 rounded-xl text-[10px] md:text-xs">
                    <div><p class="font-bold text-slate-400 uppercase">Nota</p><p id="detail-meta-invoice" class="font-bold text-slate-800">-</p></div>
                    <div><p id="detail-meta-contact-label" class="font-bold text-slate-400 uppercase">Pihak</p><p id="detail-meta-contact-name" class="font-bold text-slate-800">-</p></div>
                    <div><p class="font-bold text-slate-400 uppercase">Status</p><p id="detail-meta-status" class="font-bold">-</p></div>
                    <div><p class="font-bold text-slate-400 uppercase">Total</p><p id="detail-meta-total" class="font-black text-blue-600">-</p></div>
                </div>
                <div class="overflow-x-auto border rounded-xl"><table class="w-full text-[10px] text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3">No LOG</th><th class="p-3">Kayu</th><th class="p-3 text-center">Neto</th><th class="p-3 text-right">Harga</th></tr></thead><tbody id="detail-table-body" class="divide-y"></tbody></table></div>
                <button id="btn-print-detail-nota" class="w-full py-4 bg-amber-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center space-x-2"><i data-lucide="printer" class="w-4 h-4"></i> <span>Cetak Dokumen</span></button>
            </div>
        </div>
    </div>

    <iframe id="print-frame" style="display:none; visibility:hidden; position:absolute;"></iframe>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, serverTimestamp, writeBatch, increment, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD8m4HiTateYgP-79EmbKkqOG-lBIeikBc", authDomain: "log-master-687fd.firebaseapp.com", projectId: "log-master-687fd", storageBucket: "log-master-687fd.firebasestorage.app", messagingSenderId: "1020351029888", appId: "1:1020351029888:web:47706ebb73f446207b7c65" };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app), appId = "log-master-system";

        let inventoryData = [], contactsData = [], salesData = [], transactionsData = [], usersData = [], expensesData = [];
        let temporaryBatchWood = [], temporaryBatchSales = [], currentLiveVolWood = 0, currentLiveAvgD = 0, currentLiveVolGR = 0, isEditingNota = null, currentUserRole = "Kasir", companyProfile = { name: "Wood-IT Log", address: "Jl. Utama", phone: "0812" };

        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type==='success'?'bg-emerald-600':'bg-rose-600'} text-white px-5 py-3 rounded-2xl shadow-xl mb-3 flex items-center space-x-3`;
            toast.innerHTML = `<i data-lucide="${type==='success'?'check-circle':'alert-circle'}" class="w-4 h-4"></i><span class="text-xs font-bold">${msg}</span>`;
            container.appendChild(toast); refreshIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.toggleMobileMenu = () => { document.getElementById('mobile-extra-menu').classList.toggle('hidden'); };
        window.closeModal = (id) => { document.getElementById(`${id}-modal`).classList.add('hidden'); if(id==='wood') { isEditingNota = null; temporaryBatchWood = []; } };
        window.openModal = (type, sub = '') => { if(type==='contact') document.getElementById('contact-type').value = sub; document.getElementById(`${type}-modal`).classList.remove('hidden'); };

        window.switchView = (view) => {
            if ((view === 'reports' || view === 'settings') && currentUserRole !== 'Admin') { showToast("Akses Admin diperlukan.", "error"); return; }
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(b => b.classList.remove('text-amber-500', 'bg-amber-600', 'text-white'));
            const btn = document.getElementById(`nav-${view}`); if (btn) btn.classList.add('bg-amber-600', 'text-white');
            const mobBtn = document.getElementById(`mob-nav-${view}`); if (mobBtn) mobBtn.classList.add('text-amber-500');
            refreshIcons(); window.scrollTo(0,0);
        };

        window.liveUpdateCalc = () => {
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const d1=getVal('log-d1'), d2=getVal('log-d2'), d3=getVal('log-d3'), d4=getVal('log-d4'), p=getVal('log-p'), trim=getVal('log-trim'), gr=getVal('log-gr');
            currentLiveAvgD = Math.round((d1+d2+d3+d4)/4);
            const pEffMeter=(p-trim)/100, pAsliMeter=p/100;
            const volBruto = (0.7854 * Math.pow(currentLiveAvgD, 2) * pEffMeter) / 10000;
            currentLiveVolGR = (0.7854 * Math.pow(gr, 2) * pAsliMeter) / 10000;
            currentLiveVolWood = Math.max(0, volBruto - currentLiveVolGR);
            document.getElementById('res-live-avg-d').innerText = `${currentLiveAvgD} cm`;
            document.getElementById('res-live-vol-gr').innerText = currentLiveVolGR.toFixed(2);
            document.getElementById('res-live-vol-wood').innerText = currentLiveVolWood.toFixed(2);
        };

        window.addItemToBatch = (type) => {
            if (type === 'wood') {
                const woodType = document.getElementById('wood-type').value, noLog = document.getElementById('log-no').value;
                if (!currentLiveVolWood || !woodType) return;
                temporaryBatchWood.push({ tempId: Date.now(), type: woodType, noLog, unitVolume: parseFloat(currentLiveVolWood.toFixed(2)), volGR: parseFloat(currentLiveVolGR.toFixed(2)), totalPrice: 0, measurements: { avgD: currentLiveAvgD, p: parseFloat(document.getElementById('log-p').value) } });
            } else {
                const vol = parseFloat(document.getElementById('sales-wood-vol').value)||0, prc = parseFloat(document.getElementById('sales-wood-price').value)||0;
                if (!vol || !prc) return;
                temporaryBatchSales.push({ tempId: Date.now(), woodType: document.getElementById('sales-wood-type').value, volume: vol, price: prc, mode: 'manual', stockId: '' });
            }
            renderBatch(type);
        };

        const renderBatch = (type) => {
            const list = type === 'wood' ? temporaryBatchWood : temporaryBatchSales;
            document.getElementById(`${type}-batch-table`).innerHTML = list.map((i, idx) => `<tr class="border-b"><td class="p-3">${i.noLog||'-'}</td><td class="p-3">${i.type||i.woodType}</td><td class="p-3 text-center">${(i.unitVolume||i.volume).toFixed(2)}</td><td class="p-3 text-right"><button onclick="removeFromBatch('${type}', ${idx})" class="text-red-500 font-bold">X</button></td></tr>`).join('');
            document.getElementById(`btn-save-batch-${type}`).disabled = list.length === 0;
        };
        window.removeFromBatch = (type, idx) => { if(type==='wood') temporaryBatchWood.splice(idx,1); else temporaryBatchSales.splice(idx,1); renderBatch(type); };

        window.submitBatchToFirebase = async () => {
            const nota = document.getElementById('wood-nota').value, sid = document.getElementById('wood-supplier-select').value, totalP = parseFloat(document.getElementById('wood-total-nota-price').value)||0, status = document.getElementById('wood-payment-status').value, dp = parseFloat(document.getElementById('wood-dp-amount').value)||0;
            if(!nota || !sid) { showToast("Nota/Supplier kosong", "error"); return; }
            const batch = writeBatch(db);
            const pricePer = totalP / temporaryBatchWood.length;
            temporaryBatchWood.forEach(i => batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory')), { ...i, nota, supplierId: sid, paymentStatus: status, dpAmount: dp, totalPrice: pricePer, createdAt: serverTimestamp() }));
            let debt = status==='Hutang' ? totalP : (status==='DP' ? totalP-dp : 0); if(debt>0) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'contacts', sid), { balance: increment(debt) });
            let cash = status==='Lunas' ? totalP : (status==='DP' ? dp : 0); if(cash>0) batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'out', amount: cash, note: `Beli Log: ${nota}`, time: serverTimestamp() });
            await batch.commit(); closeModal('wood'); showToast("Nota berhasil disimpan.");
        };

        window.submitBatchSalesToFirebase = async () => {
            const nota = document.getElementById('sales-nota').value, cid = document.getElementById('sales-customer-select').value;
            const batch = writeBatch(db); let total = 0;
            temporaryBatchSales.forEach(i => { total += i.price; batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'sales')), { ...i, nota, customerId: cid, createdAt: serverTimestamp() }); });
            batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'in', amount: total, note: `Jual: ${nota}`, time: serverTimestamp() });
            await batch.commit(); closeModal('sales'); showToast("Penjualan dicatat.");
        };

        window.handleExpenseSubmit = async (e) => { e.preventDefault(); const amt = parseFloat(document.getElementById('expense-amount').value); const batch = writeBatch(db); batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses')), { category: document.getElementById('expense-category').value, amount: amt, createdAt: serverTimestamp() }); batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), { type: 'out', amount: amt, note: `Biaya: ${document.getElementById('expense-category').value}`, time: serverTimestamp() }); await batch.commit(); closeModal('expense'); showToast("Biaya tercatat."); };
        window.handleContactSubmit = async (e) => { e.preventDefault(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), { type: document.getElementById('contact-type').value, name: document.getElementById('contact-name').value, balance: 0 }); closeModal('contact'); showToast("Kontak disimpan."); };
        window.handleLogout = () => auth.signOut().then(() => location.reload());

        const startSync = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), s => { inventoryData = s.docs.map(d=>({id:d.id, ...d.data()})); renderInventory(); updateStats(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), s => { contactsData = s.docs.map(d=>({id:d.id, ...d.data()})); renderContacts(); updateSelects(); updateStats(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), s => { salesData = s.docs.map(d=>({id:d.id, ...d.data()})); renderSales(); updateStats(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => { transactionsData = s.docs.map(d=>({id:d.id, ...d.data()})); renderTransactions(); updateStats(); });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), s => { expensesData = s.docs.map(d=>({id:d.id, ...d.data()})); renderExpenses(); updateStats(); });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'company'), s => { if(s.exists()){ companyProfile = s.data(); document.getElementById('sidebar-company-name').innerText = companyProfile.name; } });
        };

        const renderInventory = () => {
            const g = inventoryData.reduce((acc, i) => { if(!acc[i.nota]) acc[i.nota] = { ...i, vol:0, prc:0 }; acc[i.nota].vol += i.unitVolume; acc[i.nota].prc += i.totalPrice; return acc; }, {});
            document.getElementById('inventory-table-body').innerHTML = Object.values(g).map(n => `<tr class="hover:bg-slate-50"><td class="px-5 py-4 font-bold text-blue-600">${n.nota}</td><td class="px-5 py-4">${contactsData.find(c=>c.id===n.supplierId)?.name||'-'}</td><td class="px-5 py-4 text-center text-[10px] font-bold">${n.paymentStatus}</td><td class="px-5 py-4 text-center font-bold">${n.vol.toFixed(2)}</td><td class="px-5 py-4 text-right">${formatCurrency(n.prc)}</td><td class="px-5 py-4 text-right no-print flex justify-end space-x-2"><button onclick="showDetail('inventory','${n.nota}')" class="p-1.5 bg-slate-100 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button></td></tr>`).join('');
            refreshIcons();
        };
        const renderSales = () => {
            const g = salesData.reduce((acc, i) => { if(!acc[i.nota]) acc[i.nota] = { ...i, vol:0, prc:0 }; acc[i.nota].vol += i.volume; acc[i.nota].prc += i.price; return acc; }, {});
            document.getElementById('sales-table-body').innerHTML = Object.values(g).map(n => `<tr class="hover:bg-slate-50"><td class="px-5 py-4 font-bold text-blue-600">${n.nota}</td><td class="px-5 py-4">${contactsData.find(c=>c.id===n.customerId)?.name||'-'}</td><td class="px-5 py-4 text-center font-bold text-[10px]">TUNTAS</td><td class="px-5 py-4 text-center font-bold">${n.vol.toFixed(2)}</td><td class="px-5 py-4 text-right">${formatCurrency(n.prc)}</td><td class="px-5 py-4 text-right"><button onclick="showDetail('sales','${n.nota}')" class="p-1.5 bg-slate-100 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button></td></tr>`).join('');
            refreshIcons();
        };
        const renderExpenses = () => { document.getElementById('expenses-table-body').innerHTML = expensesData.map(e => `<tr><td class="px-5 py-4 text-[10px]">${e.createdAt?.toDate()?.toLocaleDateString()||'-'}</td><td class="px-5 py-4 font-bold text-rose-600">${e.category}</td><td class="px-5 py-4 italic text-slate-400">Biaya Ops</td><td class="px-5 py-4 text-right font-black">${formatCurrency(e.amount)}</td><td class="px-5 py-4 text-right"><button onclick="deleteDoc(doc(db,'artifacts',appId,'public','data','expenses','${e.id}'))" class="text-slate-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join(''); refreshIcons(); };
        const renderContacts = () => {
            const cList = (c) => `<div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><div class="flex justify-between items-start"><div class="p-2 bg-slate-100 rounded-lg"><i data-lucide="${c.type==='supplier'?'truck':'users'}" class="w-4 h-4 text-slate-600"></i></div><div class="text-right text-[10px] font-bold text-slate-400 uppercase">${c.type==='supplier'?'Hutang':'Piutang'}<div class="text-sm font-bold text-slate-900">${formatCurrency(c.balance)}</div></div></div><h4 class="font-bold text-slate-800 mt-2 text-sm">${c.name}</h4><button onclick="handleDeleteContact('${c.id}')" class="text-xs text-red-400 mt-2">Hapus</button></div>`;
            document.getElementById('suppliers-list').innerHTML = contactsData.filter(c=>c.type==='supplier').map(cList).join('');
            document.getElementById('customers-list').innerHTML = contactsData.filter(c=>c.type==='customer').map(cList).join('');
            refreshIcons();
        };
        const renderTransactions = () => { document.getElementById('cashflow-table-body').innerHTML = transactionsData.sort((a,b)=>b.time?.seconds-a.time?.seconds).map(t => `<tr><td class="px-5 py-4 text-[10px]">${t.time?.toDate()?.toLocaleTimeString()||''}</td><td class="px-5 py-4 font-medium">${t.note}</td><td class="px-5 py-4"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${t.type==='in'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${t.type}</span></td><td class="px-5 py-4 text-right font-bold ${t.type==='in'?'text-green-600':'text-orange-600'}">${formatCurrency(t.amount)}</td></tr>`).join(''); };

        const updateStats = () => {
            const v = inventoryData.reduce((a,c)=>a+c.unitVolume,0), s = inventoryData.reduce((a,c)=>a+c.totalPrice,0);
            const d = contactsData.filter(c=>c.type==='supplier').reduce((a,c)=>a+c.balance,0), p = contactsData.filter(c=>c.type==='customer').reduce((a,c)=>a+c.balance,0);
            const cin = transactionsData.filter(t=>t.type==='in').reduce((a,t)=>a+t.amount,0), cout = transactionsData.filter(t=>t.type==='out').reduce((a,t)=>a+t.amount,0);
            const rev = salesData.reduce((a,c)=>a+c.price,0), buy = inventoryData.reduce((a,c)=>a+c.totalPrice,0), exp = expensesData.reduce((a,c)=>a+c.amount,0);

            document.getElementById('stat-total-volume').innerText = `${v.toFixed(2)} m³`;
            document.getElementById('stat-total-price').innerText = formatCurrency(s);
            document.getElementById('stat-total-debt').innerText = formatCurrency(d);
            document.getElementById('stat-total-receivable').innerText = formatCurrency(p);
            
            document.getElementById('report-total-revenue').innerText = formatCurrency(rev);
            document.getElementById('report-total-cogs').innerText = formatCurrency(buy);
            document.getElementById('report-total-expenses').innerText = `-${formatCurrency(exp)}`;
            document.getElementById('report-cash-in').innerText = formatCurrency(cin);
            document.getElementById('report-cash-out').innerText = formatCurrency(cout);
            document.getElementById('report-net-cash').innerText = formatCurrency(cin - cout);
            document.getElementById('report-realized-profit').innerText = formatCurrency(cin - cout);
            document.getElementById('loading').classList.add('hidden');
        };

        const updateSelects = () => {
            const sS = document.getElementById('wood-supplier-select'); if(sS) sS.innerHTML = contactsData.filter(c=>c.type==='supplier').map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
            const cS = document.getElementById('sales-customer-select'); if(cS) cS.innerHTML = contactsData.filter(c=>c.type==='customer').map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            const stS = document.getElementById('sales-stock-item-select'); if(stS) stS.innerHTML = '<option value="">Pilih Stok</option>' + inventoryData.map(i=>`<option value="${i.id}">${i.type} (${i.unitVolume.toFixed(2)})</option>`).join('');
        };

        window.showDetail = (type, nota) => {
            const m = document.getElementById('detail-modal'); let itms = [], c = null, st = "", t = 0;
            if(type==='inventory'){ itms = inventoryData.filter(i=>i.nota===nota); c = contactsData.find(x=>x.id===itms[0]?.supplierId); st = itms[0]?.paymentStatus; t = itms.reduce((a,b)=>a+b.totalPrice,0); document.getElementById('detail-meta-contact-label').innerText = "Supplier"; }
            else { itms = salesData.filter(i=>i.nota===nota); c = contactsData.find(x=>x.id===itms[0]?.customerId); st = "LUNAS"; t = itms.reduce((a,b)=>a+b.price,0); document.getElementById('detail-meta-contact-label').innerText = "Pelanggan"; }
            document.getElementById('detail-meta-invoice').innerText = nota; document.getElementById('detail-meta-contact-name').innerText = c?.name||'-'; document.getElementById('detail-meta-status').innerText = st; document.getElementById('detail-meta-total').innerText = formatCurrency(t);
            document.getElementById('detail-table-body').innerHTML = itms.map(i => `<tr><td class="p-3">${i.noLog||'-'}</td><td class="p-3 font-bold">${i.type||i.woodType}</td><td class="p-3 text-center">${(i.unitVolume||i.volume).toFixed(2)}</td><td class="p-3 text-right">${formatCurrency(i.totalPrice||i.price)}</td></tr>`).join('');
            m.classList.remove('hidden'); refreshIcons();
        };

        const syncRole = (u) => { onSnapshot(doc(db,'artifacts',appId,'public','data','users',u.uid), snap => { currentUserRole = snap.data()?.role || "Admin"; document.getElementById('user-role-badge').innerText = currentUserRole; document.querySelectorAll('.admin-only').forEach(el => currentUserRole === 'Admin' ? el.classList.remove('hidden') : el.classList.add('hidden')); }); };

        onAuthStateChanged(auth, u => { if(u){ syncRole(u); startSync(); } });
        signInAnonymously(auth); switchView('dashboard');
    </script>
</body>
</html>
